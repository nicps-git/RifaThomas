<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Auto-Sync</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-test { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>üîç Teste - Sistema de Auto-Sync</h1>
    
    <div id="status" class="test-section">
        <h2>üì° Status do Sistema</h2>
        <div id="status-info">Verificando...</div>
    </div>
    
    <div id="firebase-test" class="test-section">
        <h2>üî• Teste Firebase</h2>
        <button class="btn-test" onclick="testFirebaseMethods()">Testar M√©todos Firebase</button>
        <div id="firebase-results"></div>
    </div>
    
    <div id="autosync-test" class="test-section">
        <h2>üîÑ Teste Auto-Sync</h2>
        <button class="btn-test" onclick="testAutoSyncFunctions()">Testar Fun√ß√µes Auto-Sync</button>
        <button class="btn-success" onclick="forceRefresh()">For√ßar Atualiza√ß√£o</button>
        <button class="btn-warning" onclick="toggleTestAutoSync()">Toggle Auto-Sync</button>
        <div id="autosync-results"></div>
    </div>
    
    <div id="logs" class="test-section">
        <h2>üìù Logs em Tempo Real</h2>
        <button class="btn-test" onclick="clearLogs()">Limpar Logs</button>
        <div id="log-content" class="log"></div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        console.log('üöÄ Iniciando teste do auto-sync...');
        
        let testLogs = [];
        let autoSyncTestActive = false;
        
        // Interceptar console.log para capturar logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function addLog(type, message, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message} ${args.length > 0 ? JSON.stringify(args) : ''}`;
            testLogs.push(logEntry);
            updateLogDisplay();
            
            // Chamar console original
            if (type === 'error') originalConsoleError(message, ...args);
            else if (type === 'warn') originalConsoleWarn(message, ...args);
            else originalConsoleLog(message, ...args);
        }
        
        console.log = (...args) => addLog('log', args.join(' '));
        console.error = (...args) => addLog('error', args.join(' '));
        console.warn = (...args) => addLog('warn', args.join(' '));
        
        function updateLogDisplay() {
            const logDiv = document.getElementById('log-content');
            if (logDiv) {
                logDiv.innerHTML = testLogs.slice(-50).join('<br>'); // √öltimas 50 linhas
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        }
        
        function clearLogs() {
            testLogs = [];
            updateLogDisplay();
        }
        
        // Verificar status do sistema
        function checkSystemStatus() {
            const firebaseOK = typeof window.FirebaseDB !== 'undefined';
            const loadPurchasesOK = firebaseOK && typeof window.FirebaseDB.loadPurchases === 'function';
            const loadConfigOK = firebaseOK && typeof window.FirebaseDB.loadConfig === 'function';
            
            let statusHtml = `
                <p><strong>Firebase Dispon√≠vel:</strong> ${firebaseOK ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                <p><strong>M√©todo loadPurchases:</strong> ${loadPurchasesOK ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                <p><strong>M√©todo loadConfig:</strong> ${loadConfigOK ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
            `;
            
            // Verificar se as fun√ß√µes de auto-sync existem
            const autoSyncFunctions = [
                'initializeAutoSync',
                'refreshData', 
                'toggleAutoSync',
                'startAutoSync',
                'stopAutoSync',
                'updateSyncIndicators',
                'showSyncProgress',
                'hideSyncProgress',
                'loadDataFromFirebase'
            ];
            
            statusHtml += '<h4>Fun√ß√µes Auto-Sync:</h4><ul>';
            autoSyncFunctions.forEach(func => {
                const exists = typeof window[func] === 'function';
                statusHtml += `<li><strong>${func}:</strong> ${exists ? '‚úÖ SIM' : '‚ùå N√ÉO'}</li>`;
            });
            statusHtml += '</ul>';
            
            document.getElementById('status-info').innerHTML = statusHtml;
        }
        
        // Testar m√©todos do Firebase
        async function testFirebaseMethods() {
            let results = '<h4>Testando m√©todos Firebase:</h4>';
            
            try {
                if (!window.FirebaseDB) {
                    results += '<p class="error">‚ùå FirebaseDB n√£o dispon√≠vel</p>';
                    document.getElementById('firebase-results').innerHTML = results;
                    return;
                }
                
                console.log('üß™ Testando loadPurchases...');
                const purchasesResult = await window.FirebaseDB.loadPurchases();
                results += `<p><strong>loadPurchases:</strong> ${purchasesResult.success ? '‚úÖ Sucesso' : '‚ùå Falha'}</p>`;
                if (purchasesResult.success) {
                    results += `<p>‚Üí ${purchasesResult.data.length} compras carregadas</p>`;
                } else {
                    results += `<p>‚Üí Erro: ${purchasesResult.error}</p>`;
                }
                
                console.log('üß™ Testando loadConfig...');
                const configResult = await window.FirebaseDB.loadConfig();
                results += `<p><strong>loadConfig:</strong> ${configResult.success ? '‚úÖ Sucesso' : '‚ùå Falha'}</p>`;
                if (configResult.success) {
                    results += `<p>‚Üí Config carregada: ${JSON.stringify(configResult.data, null, 2)}</p>`;
                } else {
                    results += `<p>‚Üí Erro: ${configResult.error}</p>`;
                }
                
            } catch (error) {
                console.error('Erro nos testes Firebase:', error);
                results += `<p class="error">‚ùå Erro geral: ${error.message}</p>`;
            }
            
            document.getElementById('firebase-results').innerHTML = results;
        }
        
        // Testar fun√ß√µes do auto-sync
        function testAutoSyncFunctions() {
            console.log('üß™ Testando fun√ß√µes do auto-sync...');
            
            let results = '<h4>Testando fun√ß√µes Auto-Sync:</h4>';
            
            try {
                // Testar updateSyncIndicators
                if (typeof window.updateSyncIndicators === 'function') {
                    console.log('üß™ Testando updateSyncIndicators...');
                    window.updateSyncIndicators();
                    results += '<p>‚úÖ updateSyncIndicators executada</p>';
                } else {
                    results += '<p>‚ùå updateSyncIndicators n√£o encontrada</p>';
                }
                
                // Testar showSyncProgress
                if (typeof window.showSyncProgress === 'function') {
                    console.log('üß™ Testando showSyncProgress...');
                    window.showSyncProgress(50, 'Teste de progresso');
                    results += '<p>‚úÖ showSyncProgress executada</p>';
                    
                    setTimeout(() => {
                        if (typeof window.hideSyncProgress === 'function') {
                            window.hideSyncProgress();
                        }
                    }, 2000);
                } else {
                    results += '<p>‚ùå showSyncProgress n√£o encontrada</p>';
                }
                
                // Testar loadDataFromFirebase
                if (typeof window.loadDataFromFirebase === 'function') {
                    console.log('üß™ Testando loadDataFromFirebase...');
                    window.loadDataFromFirebase().then(() => {
                        console.log('‚úÖ loadDataFromFirebase conclu√≠da');
                    }).catch(error => {
                        console.error('‚ùå loadDataFromFirebase falhou:', error);
                    });
                    results += '<p>‚úÖ loadDataFromFirebase iniciada (veja logs)</p>';
                } else {
                    results += '<p>‚ùå loadDataFromFirebase n√£o encontrada</p>';
                }
                
            } catch (error) {
                console.error('Erro nos testes auto-sync:', error);
                results += `<p class="error">‚ùå Erro: ${error.message}</p>`;
            }
            
            document.getElementById('autosync-results').innerHTML = results;
        }
        
        // For√ßar refresh
        function forceRefresh() {
            if (typeof window.refreshData === 'function') {
                console.log('üîÑ For√ßando refresh...');
                window.refreshData();
            } else {
                console.error('‚ùå Fun√ß√£o refreshData n√£o encontrada');
            }
        }
        
        // Toggle auto-sync
        function toggleTestAutoSync() {
            if (typeof window.toggleAutoSync === 'function') {
                console.log('üîÑ Toggling auto-sync...');
                window.toggleAutoSync();
            } else {
                console.error('‚ùå Fun√ß√£o toggleAutoSync n√£o encontrada');
            }
        }
        
        // Aguardar Firebase estar pronto
        function waitForFirebase() {
            return new Promise((resolve) => {
                if (window.FirebaseDB) {
                    resolve();
                } else {
                    window.addEventListener('firebaseReady', resolve);
                }
            });
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÑ DOM carregado, aguardando Firebase...');
            checkSystemStatus();
            
            // Aguardar Firebase
            await waitForFirebase();
            console.log('üî• Firebase pronto!');
            
            // Verificar novamente ap√≥s Firebase estar pronto
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html>
