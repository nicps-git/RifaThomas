<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Firebase - DiagnÃ³stico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        
        button:hover { background: #0056b3; }
        .success-btn { background: #28a745; }
        .warning-btn { background: #ffc107; color: black; }
        .danger-btn { background: #dc3545; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .data-box {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Teste Firebase - DiagnÃ³stico de ConexÃ£o</h1>
    
    <div id="status" class="status">Iniciando testes...</div>
    
    <div class="section">
        <h2>ğŸ“‹ 1. Teste de Carregamento do Firebase</h2>
        <button onclick="testFirebaseLoad()" class="success-btn">ğŸ”„ Testar Carregamento</button>
        <button onclick="clearLog()" class="warning-btn">ğŸ§¹ Limpar Log</button>
        
        <div id="firebase-log" class="log">Aguardando teste...</div>
    </div>

    <div class="section">
        <h2>ğŸ” 2. Teste de AutenticaÃ§Ã£o</h2>
        <button onclick="testAuth()" class="success-btn">ğŸ”‘ Testar AutenticaÃ§Ã£o</button>
        
        <div id="auth-status" class="data-box">Status da autenticaÃ§Ã£o aparecerÃ¡ aqui...</div>
    </div>

    <div class="section">
        <h2>ğŸ“Š 3. Teste de Leitura de Dados</h2>
        <button onclick="testReadData()" class="success-btn">ğŸ“– Ler Compras do Firebase</button>
        <button onclick="testSoldNumbers()" class="success-btn">ğŸ”¢ Ler NÃºmeros Vendidos</button>
        
        <div id="data-status" class="data-box">Dados do Firebase aparecerÃ£o aqui...</div>
    </div>

    <div class="section">
        <h2>âœï¸ 4. Teste de Escrita de Dados</h2>
        <button onclick="testWriteData()" class="warning-btn">ğŸ“ Criar Compra de Teste</button>
        <button onclick="testUpdateData()" class="warning-btn">ğŸ”„ Atualizar Status</button>
        
        <div id="write-status" class="data-box">Status das operaÃ§Ãµes de escrita...</div>
    </div>

    <div class="section">
        <h2>ğŸ¯ 5. ComparaÃ§Ã£o localStorage vs Firebase</h2>
        <button onclick="compareData()" class="success-btn">âš–ï¸ Comparar Dados</button>
        
        <div id="comparison" class="data-box">ComparaÃ§Ã£o aparecerÃ¡ aqui...</div>
    </div>

    <!-- Carregar Firebase -->
    <script type="module" src="firebase-config.js"></script>
    
    <script>
        let testResults = {
            firebaseLoaded: false,
            authenticated: false,
            canRead: false,
            canWrite: false,
            lastTestPurchaseId: null
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('firebase-log');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            
            logDiv.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`${emoji} ${message}`);
            
            // Atualizar status geral
            updateStatus();
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status');
            let statusText = '';
            let statusClass = '';
            
            if (testResults.firebaseLoaded && testResults.authenticated && testResults.canRead) {
                statusText = 'âœ… Firebase funcionando corretamente!';
                statusClass = 'success';
            } else if (testResults.firebaseLoaded) {
                statusText = 'âš ï¸ Firebase carregado, mas com problemas de conexÃ£o';
                statusClass = 'warning';
            } else {
                statusText = 'âŒ Firebase nÃ£o carregado corretamente';
                statusClass = 'error';
            }
            
            statusDiv.textContent = statusText;
            statusDiv.className = `status ${statusClass}`;
        }

        function clearLog() {
            document.getElementById('firebase-log').textContent = '';
            log('Log limpo', 'info');
        }

        async function testFirebaseLoad() {
            log('ğŸ”„ Testando carregamento do Firebase...', 'info');
            
            // Aguardar um pouco para Firebase carregar
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            if (typeof window.FirebaseDB !== 'undefined') {
                log('âœ… Firebase carregado com sucesso!', 'success');
                log(`ğŸ”§ FunÃ§Ãµes disponÃ­veis: ${Object.keys(window.FirebaseDB).join(', ')}`, 'info');
                testResults.firebaseLoaded = true;
            } else {
                log('âŒ Firebase nÃ£o foi carregado!', 'error');
                log('ğŸ” Verificando se o script foi incluÃ­do...', 'info');
                
                const scripts = Array.from(document.scripts);
                const firebaseScript = scripts.find(s => s.src.includes('firebase-config.js'));
                
                if (firebaseScript) {
                    log('âœ… Script firebase-config.js encontrado', 'info');
                    log(`ğŸ“ Tipo: ${firebaseScript.type || 'text/javascript'}`, 'info');
                } else {
                    log('âŒ Script firebase-config.js nÃ£o encontrado!', 'error');
                }
                
                testResults.firebaseLoaded = false;
            }
        }

        async function testAuth() {
            if (!testResults.firebaseLoaded) {
                log('âŒ Firebase nÃ£o carregado. Execute primeiro o teste de carregamento.', 'error');
                return;
            }

            log('ğŸ”‘ Testando autenticaÃ§Ã£o...', 'info');
            
            try {
                const user = await window.FirebaseDB.initAuth();
                log('âœ… AutenticaÃ§Ã£o bem-sucedida!', 'success');
                log(`ğŸ‘¤ UsuÃ¡rio: ${user.uid}`, 'info');
                
                document.getElementById('auth-status').textContent = JSON.stringify({
                    uid: user.uid,
                    isAnonymous: user.isAnonymous,
                    authenticated: true
                }, null, 2);
                
                testResults.authenticated = true;
                
            } catch (error) {
                log(`âŒ Erro na autenticaÃ§Ã£o: ${error.message}`, 'error');
                document.getElementById('auth-status').textContent = `Erro: ${error.message}`;
                testResults.authenticated = false;
            }
        }

        async function testReadData() {
            if (!testResults.authenticated) {
                log('âŒ NÃ£o autenticado. Execute primeiro o teste de autenticaÃ§Ã£o.', 'error');
                return;
            }

            log('ğŸ“– Testando leitura de dados...', 'info');
            
            try {
                const result = await window.FirebaseDB.getPurchases();
                
                if (result.success) {
                    log(`âœ… Leitura bem-sucedida! ${result.data.length} compras encontradas`, 'success');
                    
                    document.getElementById('data-status').textContent = 
                        `Compras encontradas: ${result.data.length}\n\n` +
                        JSON.stringify(result.data, null, 2);
                    
                    testResults.canRead = true;
                    
                } else {
                    log(`âŒ Erro na leitura: ${result.error}`, 'error');
                    document.getElementById('data-status').textContent = `Erro: ${result.error}`;
                    testResults.canRead = false;
                }
                
            } catch (error) {
                log(`âŒ Erro na leitura: ${error.message}`, 'error');
                document.getElementById('data-status').textContent = `Erro: ${error.message}`;
                testResults.canRead = false;
            }
        }

        async function testSoldNumbers() {
            if (!testResults.authenticated) {
                log('âŒ NÃ£o autenticado. Execute primeiro o teste de autenticaÃ§Ã£o.', 'error');
                return;
            }

            log('ğŸ”¢ Testando busca de nÃºmeros vendidos...', 'info');
            
            try {
                const result = await window.FirebaseDB.getSoldNumbers();
                
                if (result.success) {
                    log(`âœ… NÃºmeros vendidos obtidos! ${result.data.length} nÃºmeros`, 'success');
                    log(`ğŸ”¢ NÃºmeros: [${result.data.sort((a,b) => a-b).join(', ')}]`, 'info');
                    
                    const currentData = document.getElementById('data-status').textContent;
                    document.getElementById('data-status').textContent = 
                        currentData + `\n\nNÃºmeros vendidos (${result.data.length}): [${result.data.join(', ')}]`;
                    
                } else {
                    log(`âŒ Erro ao obter nÃºmeros: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro ao obter nÃºmeros: ${error.message}`, 'error');
            }
        }

        async function testWriteData() {
            if (!testResults.authenticated) {
                log('âŒ NÃ£o autenticado. Execute primeiro o teste de autenticaÃ§Ã£o.', 'error');
                return;
            }

            log('ğŸ“ Testando escrita de dados...', 'info');
            
            const testPurchase = {
                buyerName: 'Teste Firebase',
                buyerPhone: '(11) 99999-9999',
                numbers: [Math.floor(Math.random() * 150) + 1],
                totalAmount: 40.00,
                paymentMethod: 'pix',
                status: 'confirmed',
                timestamp: new Date().toISOString()
            };
            
            try {
                const result = await window.FirebaseDB.savePurchase(testPurchase);
                
                if (result.success) {
                    log(`âœ… Escrita bem-sucedida! ID: ${result.id}`, 'success');
                    log(`ğŸ”¢ NÃºmero testado: ${testPurchase.numbers[0]}`, 'info');
                    
                    testResults.lastTestPurchaseId = result.id;
                    testResults.canWrite = true;
                    
                    document.getElementById('write-status').textContent = 
                        `Compra de teste criada:\nID: ${result.id}\nNÃºmero: ${testPurchase.numbers[0]}\nStatus: confirmed`;
                    
                } else {
                    log(`âŒ Erro na escrita: ${result.error}`, 'error');
                    document.getElementById('write-status').textContent = `Erro: ${result.error}`;
                    testResults.canWrite = false;
                }
                
            } catch (error) {
                log(`âŒ Erro na escrita: ${error.message}`, 'error');
                document.getElementById('write-status').textContent = `Erro: ${error.message}`;
                testResults.canWrite = false;
            }
        }

        async function testUpdateData() {
            if (!testResults.lastTestPurchaseId) {
                log('âŒ Nenhuma compra de teste criada. Execute primeiro o teste de escrita.', 'error');
                return;
            }

            log('ğŸ”„ Testando atualizaÃ§Ã£o de dados...', 'info');
            
            try {
                const result = await window.FirebaseDB.updatePurchaseStatus(
                    testResults.lastTestPurchaseId, 
                    'pending_donation',
                    { updatedBy: 'teste-automatico' }
                );
                
                if (result.success) {
                    log('âœ… AtualizaÃ§Ã£o bem-sucedida!', 'success');
                    
                    const currentStatus = document.getElementById('write-status').textContent;
                    document.getElementById('write-status').textContent = 
                        currentStatus + `\n\nStatus atualizado para: pending_donation`;
                    
                } else {
                    log(`âŒ Erro na atualizaÃ§Ã£o: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro na atualizaÃ§Ã£o: ${error.message}`, 'error');
            }
        }

        async function compareData() {
            log('âš–ï¸ Comparando dados localStorage vs Firebase...', 'info');
            
            // Dados do localStorage
            const localPurchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const localSold = new Set();
            localPurchases.forEach(p => {
                if (p.status === 'confirmed' && p.numbers) {
                    p.numbers.forEach(n => localSold.add(n));
                }
            });
            
            // Dados do Firebase
            let firebaseSold = new Set();
            if (testResults.authenticated) {
                try {
                    const result = await window.FirebaseDB.getSoldNumbers();
                    if (result.success) {
                        firebaseSold = new Set(result.data);
                    }
                } catch (error) {
                    log(`âŒ Erro ao ler Firebase: ${error.message}`, 'error');
                }
            }
            
            const comparison = {
                localStorage: {
                    totalPurchases: localPurchases.length,
                    soldNumbers: Array.from(localSold).sort((a,b) => a-b),
                    count: localSold.size
                },
                firebase: {
                    soldNumbers: Array.from(firebaseSold).sort((a,b) => a-b),
                    count: firebaseSold.size
                },
                differences: {
                    onlyInLocal: Array.from(localSold).filter(n => !firebaseSold.has(n)),
                    onlyInFirebase: Array.from(firebaseSold).filter(n => !localSold.has(n))
                }
            };
            
            document.getElementById('comparison').textContent = JSON.stringify(comparison, null, 2);
            
            if (comparison.differences.onlyInLocal.length === 0 && comparison.differences.onlyInFirebase.length === 0) {
                log('âœ… Dados sincronizados! localStorage e Firebase tÃªm os mesmos nÃºmeros.', 'success');
            } else {
                log('âš ï¸ Dados diferentes entre localStorage e Firebase!', 'warning');
                log(`ğŸ“¦ SÃ³ no localStorage: [${comparison.differences.onlyInLocal.join(', ')}]`, 'warning');
                log(`ğŸ”¥ SÃ³ no Firebase: [${comparison.differences.onlyInFirebase.join(', ')}]`, 'warning');
            }
        }

        // InicializaÃ§Ã£o automÃ¡tica
        window.addEventListener('load', () => {
            log('ğŸš€ PÃ¡gina de teste carregada', 'info');
            log('â–¶ï¸ Execute os testes na ordem para diagnosticar problemas', 'info');
            
            // Teste automÃ¡tico apÃ³s 2 segundos
            setTimeout(() => {
                log('ğŸ”„ Iniciando teste automÃ¡tico...', 'info');
                testFirebaseLoad();
            }, 2000);
        });
    </script>
</body>
</html>
