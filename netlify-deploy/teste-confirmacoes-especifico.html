<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Confirma√ß√µes - Admin RifaThomas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .result.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .status-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status-card.ready {
            background: #d4edda;
        }
        .status-card.error {
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Teste de Confirma√ß√µes - Admin</h1>
        <p>Esta p√°gina testa especificamente as funcionalidades de confirma√ß√£o/rejei√ß√£o do painel admin.</p>

        <div class="test-section">
            <h3>üìä Status do Sistema</h3>
            <div id="system-status" class="status-card">
                Verificando...
            </div>
            <button class="btn btn-info" onclick="checkSystemStatus()">Verificar Status</button>
        </div>

        <div class="test-section">
            <h3>üîó Carregar Admin</h3>
            <p>Primeiro, carregue o sistema admin no contexto desta p√°gina:</p>
            <button class="btn btn-primary" onclick="loadAdminSystem()">Carregar Admin</button>
            <button class="btn btn-info" onclick="openAdminInNewTab()">Abrir Admin (Nova Aba)</button>
            <div id="admin-load-status" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Criar Dados de Teste</h3>
            <p>Crie dados de teste para verificar as confirma√ß√µes:</p>
            <button class="btn btn-warning" onclick="createTestPurchase()">Criar Compra Teste</button>
            <button class="btn btn-info" onclick="listPurchases()">Listar Compras</button>
            <div id="test-data-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>‚úÖ Testar Confirma√ß√µes</h3>
            <p>Teste as fun√ß√µes de confirma√ß√£o e rejei√ß√£o:</p>
            <button class="btn btn-success" onclick="testConfirmFunction()">Testar Confirma√ß√£o</button>
            <button class="btn btn-danger" onclick="testRejectFunction()">Testar Rejei√ß√£o</button>
            <button class="btn btn-info" onclick="testTableDisplay()">Testar Exibi√ß√£o Tabela</button>
            <div id="confirmation-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üîß Debug Avan√ßado</h3>
            <p>Ferramentas de debug para identificar problemas:</p>
            <button class="btn btn-info" onclick="debugSystemState()">Debug Estado</button>
            <button class="btn btn-warning" onclick="forceFunctionTest()">For√ßar Teste Fun√ß√µes</button>
            <button class="btn btn-primary" onclick="checkDOMElements()">Verificar DOM</button>
            <div id="debug-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üì± Console Log</h3>
            <p>Logs em tempo real (abra o console do navegador tamb√©m):</p>
            <div id="console-log" class="result" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn btn-warning" onclick="clearConsole()">Limpar Console</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        let testState = {
            adminLoaded: false,
            firebaseReady: false,
            testData: []
        };

        // Log function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const consoleDiv = document.getElementById('console-log');
            const logEntry = `[${timestamp}] ${message}\n`;
            consoleDiv.textContent += logEntry;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            const colors = {
                info: 'color: #007bff;',
                success: 'color: #28a745;',
                error: 'color: #dc3545;',
                warning: 'color: #ffc107;'
            };
            
            console.log(`%c[TEST ${type.toUpperCase()}] ${message}`, colors[type] || colors.info);
        }

        function updateResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }

        async function checkSystemStatus() {
            log('üîç Verificando status do sistema...', 'info');
            
            const statusDiv = document.getElementById('system-status');
            let status = '';
            let statusClass = 'status-card';
            
            // Check Firebase
            if (typeof window.FirebaseDB !== 'undefined') {
                testState.firebaseReady = true;
                status += '‚úÖ Firebase carregado\n';
                
                try {
                    const user = await window.FirebaseDB.getCurrentAdmin();
                    if (user.success) {
                        status += `‚úÖ Admin logado: ${user.user.email}\n`;
                        statusClass += ' ready';
                    } else {
                        status += '‚ö†Ô∏è Firebase OK mas n√£o logado como admin\n';
                        statusClass += ' error';
                    }
                } catch (error) {
                    status += `‚ùå Erro Firebase: ${error.message}\n`;
                    statusClass += ' error';
                }
            } else {
                status += '‚ùå Firebase n√£o carregado\n';
                statusClass += ' error';
            }
            
            // Check Admin functions
            const adminFunctions = ['confirmDonation', 'rejectDonation', 'loadParticipants'];
            adminFunctions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    status += `‚úÖ ${funcName}() dispon√≠vel\n`;
                } else {
                    status += `‚ùå ${funcName}() n√£o encontrada\n`;
                    statusClass += ' error';
                }
            });
            
            statusDiv.textContent = status;
            statusDiv.className = statusClass;
            
            log('Status verificado', 'success');
        }

        function loadAdminSystem() {
            log('üîó Carregando sistema admin...', 'info');
            
            // Create iframe to load admin
            const iframe = document.createElement('iframe');
            iframe.src = 'admin.html';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            iframe.onload = () => {
                log('üì± Admin iframe carregado', 'success');
                
                // Try to access admin functions
                setTimeout(() => {
                    try {
                        const adminWindow = iframe.contentWindow;
                        if (adminWindow.confirmDonation) {
                            testState.adminLoaded = true;
                            updateResult('admin-load-status', 'Admin carregado com sucesso!', 'success');
                            log('‚úÖ Fun√ß√µes admin acess√≠veis', 'success');
                        } else {
                            updateResult('admin-load-status', 'Admin carregado mas fun√ß√µes n√£o acess√≠veis', 'error');
                            log('‚ö†Ô∏è Fun√ß√µes admin n√£o acess√≠veis (cross-origin)', 'warning');
                        }
                    } catch (error) {
                        updateResult('admin-load-status', `Erro ao acessar admin: ${error.message}`, 'error');
                        log(`‚ùå Erro: ${error.message}`, 'error');
                    }
                }, 2000);
            };
        }

        function openAdminInNewTab() {
            log('üîó Abrindo admin em nova aba...', 'info');
            window.open('admin.html', '_blank');
            updateResult('admin-load-status', 'Admin aberto em nova aba - verifique o console da outra aba', 'info');
        }

        async function createTestPurchase() {
            log('üß™ Criando compra de teste...', 'info');
            
            if (!testState.firebaseReady) {
                updateResult('test-data-result', 'Firebase n√£o est√° pronto', 'error');
                return;
            }
            
            try {
                const testPurchase = {
                    buyerName: 'Teste Confirma√ß√£o ' + Date.now(),
                    buyerPhone: '(11) 99999-9999',
                    numbers: [Math.floor(Math.random() * 150) + 1],
                    totalAmount: 40.00,
                    paymentMethod: 'doacao',
                    status: 'pending_donation',
                    date: new Date().toISOString()
                };
                
                const result = await window.FirebaseDB.savePurchase(testPurchase);
                
                if (result.success) {
                    testState.testData.push(result.id);
                    updateResult('test-data-result', `Compra criada: ${result.id}`, 'success');
                    log(`‚úÖ Compra criada: ${result.id}`, 'success');
                } else {
                    updateResult('test-data-result', `Erro: ${result.error}`, 'error');
                    log(`‚ùå Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                updateResult('test-data-result', `Erro: ${error.message}`, 'error');
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function listPurchases() {
            log('üìä Listando compras...', 'info');
            
            if (!testState.firebaseReady) {
                updateResult('test-data-result', 'Firebase n√£o est√° pronto', 'error');
                return;
            }
            
            try {
                const result = await window.FirebaseDB.getPurchases();
                
                if (result.success) {
                    const purchases = result.data;
                    const pendingDonations = purchases.filter(p => p.status === 'pending_donation');
                    
                    let listText = `Total: ${purchases.length} compras\n`;
                    listText += `Doa√ß√µes pendentes: ${pendingDonations.length}\n\n`;
                    
                    pendingDonations.forEach(p => {
                        listText += `ID: ${p.id}\n`;
                        listText += `Nome: ${p.buyerName || p.name}\n`;
                        listText += `Status: ${p.status}\n\n`;
                    });
                    
                    updateResult('test-data-result', listText, 'success');
                    log(`‚úÖ ${purchases.length} compras carregadas`, 'success');
                } else {
                    updateResult('test-data-result', `Erro: ${result.error}`, 'error');
                }
            } catch (error) {
                updateResult('test-data-result', `Erro: ${error.message}`, 'error');
            }
        }

        function testConfirmFunction() {
            log('‚úÖ Testando fun√ß√£o de confirma√ß√£o...', 'info');
            
            if (typeof confirmDonation === 'function') {
                updateResult('confirmation-result', 'Fun√ß√£o confirmDonation encontrada!', 'success');
                log('‚úÖ confirmDonation() dispon√≠vel', 'success');
                
                // Simular teste sem executar
                log('üí° Para testar: use o console e chame confirmDonation("ID_DA_COMPRA")', 'info');
            } else {
                updateResult('confirmation-result', 'Fun√ß√£o confirmDonation N√ÉO encontrada', 'error');
                log('‚ùå confirmDonation() n√£o dispon√≠vel', 'error');
                log('üí° A fun√ß√£o pode estar em outro contexto (iframe/outra aba)', 'warning');
            }
        }

        function testRejectFunction() {
            log('‚ùå Testando fun√ß√£o de rejei√ß√£o...', 'info');
            
            if (typeof rejectDonation === 'function') {
                updateResult('confirmation-result', 'Fun√ß√£o rejectDonation encontrada!', 'success');
                log('‚úÖ rejectDonation() dispon√≠vel', 'success');
            } else {
                updateResult('confirmation-result', 'Fun√ß√£o rejectDonation N√ÉO encontrada', 'error');
                log('‚ùå rejectDonation() n√£o dispon√≠vel', 'error');
            }
        }

        function testTableDisplay() {
            log('üìã Testando exibi√ß√£o da tabela...', 'info');
            
            const tbody = document.getElementById('participants-tbody');
            if (tbody) {
                updateResult('confirmation-result', 'Elemento participants-tbody encontrado nesta p√°gina!', 'success');
                log('‚úÖ participants-tbody encontrado', 'success');
            } else {
                updateResult('confirmation-result', 'Elemento participants-tbody N√ÉO encontrado nesta p√°gina', 'error');
                log('‚ùå participants-tbody n√£o encontrado', 'error');
                log('üí° Normal - este elemento est√° na p√°gina admin.html', 'info');
            }
        }

        function debugSystemState() {
            log('üîß Debug do estado do sistema...', 'info');
            
            const debugInfo = {
                window_FirebaseDB: typeof window.FirebaseDB,
                window_confirmDonation: typeof window.confirmDonation,
                window_rejectDonation: typeof window.rejectDonation,
                window_adminData: typeof window.adminData,
                window_debugAdmin: typeof window.debugAdmin,
                document_readyState: document.readyState,
                location_href: window.location.href
            };
            
            updateResult('debug-result', JSON.stringify(debugInfo, null, 2), 'info');
            log('üîç Estado do sistema logado', 'info');
        }

        function forceFunctionTest() {
            log('‚ö° For√ßando teste das fun√ß√µes...', 'warning');
            
            // Tentar executar via eval (apenas para debug)
            try {
                if (typeof window.FirebaseDB !== 'undefined') {
                    log('‚úÖ Firebase dispon√≠vel para teste', 'success');
                } else {
                    log('‚ùå Firebase n√£o dispon√≠vel', 'error');
                }
                
                updateResult('debug-result', 'Teste for√ßado conclu√≠do - veja o console', 'info');
            } catch (error) {
                updateResult('debug-result', `Erro no teste for√ßado: ${error.message}`, 'error');
            }
        }

        function checkDOMElements() {
            log('üîç Verificando elementos DOM...', 'info');
            
            const importantElements = [
                'participants-tbody',
                'total-participants',
                'total-revenue',
                'config-form'
            ];
            
            let domCheck = 'Verifica√ß√£o DOM:\n';
            importantElements.forEach(id => {
                const element = document.getElementById(id);
                domCheck += `${id}: ${element ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}\n`;
            });
            
            updateResult('debug-result', domCheck, 'info');
            log('üîç Verifica√ß√£o DOM conclu√≠da', 'info');
        }

        function clearConsole() {
            document.getElementById('console-log').textContent = '';
            log('üßπ Console limpo', 'info');
        }

        // Auto-initialize
        window.addEventListener('load', () => {
            log('üöÄ P√°gina de teste carregada', 'info');
            setTimeout(checkSystemStatus, 1000);
        });

        // Listen for Firebase ready
        window.addEventListener('firebaseReady', () => {
            testState.firebaseReady = true;
            log('üî• Firebase ready detectado', 'success');
            checkSystemStatus();
        });
    </script>
</body>
</html>
