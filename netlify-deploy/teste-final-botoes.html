<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Final - Bot√µes de Confirma√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .btn-test { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .highlight-success { background-color: #d4edda !important; }
        .highlight-error { background-color: #f8d7da !important; }
        .highlight-warning { background-color: #fff3cd !important; }
        .code-block { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üéØ Teste Final - Corre√ß√£o dos Bot√µes de Confirma√ß√£o</h1>
    
    <div class="debug-section info">
        <h2>üìã Resumo das Corre√ß√µes Aplicadas</h2>
        <ul>
            <li>‚úÖ Fun√ß√£o <code>normalizeString()</code> para remover acentos e normalizar texto</li>
            <li>‚úÖ Fun√ß√£o <code>isDoacaoRobusta()</code> que verifica m√∫ltiplos campos e varia√ß√µes</li>
            <li>‚úÖ Fun√ß√£o <code>isStatusPendenteRobusta()</code> que aceita diferentes formatos de status</li>
            <li>‚úÖ Atualiza√ß√£o da fun√ß√£o <code>createActionButtons()</code> para usar l√≥gica robusta</li>
            <li>‚úÖ Atualiza√ß√£o da fun√ß√£o <code>loadParticipants()</code> para filtros robustos</li>
        </ul>
    </div>
    
    <div class="debug-section">
        <h2>üîó Conex√£o Firebase</h2>
        <div id="firebase-status">Verificando...</div>
    </div>
    
    <div class="debug-section">
        <h2>üß™ Teste da Nova L√≥gica</h2>
        <button class="btn-test" onclick="testarLogicaFinal()">Testar L√≥gica Completa</button>
        <div id="teste-logica"></div>
    </div>
    
    <div class="debug-section">
        <h2>üìä An√°lise Final dos Dados</h2>
        <button class="btn-test" onclick="analiseFinalDados()">Carregar e Analisar Dados</button>
        <div id="analise-final"></div>
    </div>
    
    <div class="debug-section">
        <h2>‚úÖ Resultados do Teste</h2>
        <div id="resultados-teste"></div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        console.log('üöÄ Iniciando teste final da corre√ß√£o dos bot√µes...');
        
        let db = null;
        let dadosCompletos = [];
        
        // Fun√ß√µes da nova l√≥gica (copiadas do admin.js corrigido)
        function normalizeString(str) {
            if (!str) return '';
            return str.toString().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')  // Remove acentos
                .replace(/[^\w\s]/g, '')         // Remove pontua√ß√£o
                .trim();
        }
        
        function isDoacaoRobusta(purchase) {
            if (!purchase) return false;
            
            const tipoNorm = normalizeString(purchase.tipo || '');
            const metodoPagamentoNorm = normalizeString(purchase.metodoPagamento || purchase.paymentMethod || '');
            const observacoesNorm = normalizeString(purchase.observacoes || purchase.notes || '');
            
            const variacoesDoacao = ['doacao', 'doac√£o', 'doa√ß√£o', 'donation'];
            
            return variacoesDoacao.some(variacao => 
                tipoNorm.includes(variacao) || 
                metodoPagamentoNorm.includes(variacao) ||
                observacoesNorm.includes(variacao)
            );
        }
        
        function isStatusPendenteRobusta(purchase) {
            if (!purchase) return false;
            
            const statusNorm = normalizeString(purchase.status || '');
            const variacoesPendente = ['pendente', 'pending', 'aguardando', 'nao confirmado', 'naoconfirmado'];
            
            return variacoesPendente.some(variacao => statusNorm.includes(variacao));
        }
        
        function deveExibirBotoes(purchase) {
            return isDoacaoRobusta(purchase) && isStatusPendenteRobusta(purchase);
        }
        
        // Inicializar Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                document.getElementById('firebase-status').innerHTML = '‚úÖ Firebase conectado com sucesso';
                return true;
            } catch (error) {
                document.getElementById('firebase-status').innerHTML = `‚ùå Erro: ${error.message}`;
                console.error('Erro Firebase:', error);
                return false;
            }
        }
        
        // Testar a nova l√≥gica com casos pr√©-definidos
        function testarLogicaFinal() {
            const testeDiv = document.getElementById('teste-logica');
            
            const casosTeste = [
                // Casos que DEVEM ter bot√µes
                { id: 'teste1', tipo: 'Doa√ß√£o', status: 'Pendente', expect: true },
                { id: 'teste2', tipo: 'doacao', status: 'pendente', expect: true },
                { id: 'teste3', tipo: 'DOACAO', status: 'PENDENTE', expect: true },
                { id: 'teste4', metodoPagamento: 'Doa√ß√£o PIX', status: 'Pendente', expect: true },
                { id: 'teste5', paymentMethod: 'donation', status: 'pending', expect: true },
                { id: 'teste6', observacoes: 'Esta √© uma doa√ß√£o', status: 'aguardando', expect: true },
                
                // Casos que N√ÉO devem ter bot√µes
                { id: 'teste7', tipo: 'Doa√ß√£o', status: 'Confirmado', expect: false },
                { id: 'teste8', tipo: 'Compra', status: 'Pendente', expect: false },
                { id: 'teste9', tipo: '', status: 'Pendente', expect: false },
                { id: 'teste10', tipo: null, status: null, expect: false },
            ];
            
            let html = '<h4>üß™ Resultados dos Testes de L√≥gica</h4>';
            html += '<table><thead><tr><th>ID</th><th>Dados</th><th>Esperado</th><th>Resultado</th><th>Status</th></tr></thead><tbody>';
            
            let sucessos = 0;
            let falhas = 0;
            
            casosTeste.forEach(caso => {
                const resultado = deveExibirBotoes(caso);
                const sucesso = resultado === caso.expect;
                
                if (sucesso) sucessos++;
                else falhas++;
                
                const classe = sucesso ? 'highlight-success' : 'highlight-error';
                const statusIcon = sucesso ? '‚úÖ' : '‚ùå';
                
                html += `
                    <tr class="${classe}">
                        <td>${caso.id}</td>
                        <td>${JSON.stringify(caso, null, 1).replace(/[\{\}\"]/g, '').replace(/,/g, '<br>')}</td>
                        <td>${caso.expect ? 'TER bot√µes' : 'N√ÉO ter bot√µes'}</td>
                        <td>${resultado ? 'TEM bot√µes' : 'N√ÉO tem bot√µes'}</td>
                        <td>${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            const resumoClasse = falhas === 0 ? 'success' : 'warning';
            html += `
                <div class="${resumoClasse}" style="margin-top: 15px; padding: 10px; border-radius: 4px;">
                    <h4>üìä Resumo dos Testes</h4>
                    <ul>
                        <li><strong>Sucessos:</strong> ${sucessos}/${casosTeste.length}</li>
                        <li><strong>Falhas:</strong> ${falhas}/${casosTeste.length}</li>
                        <li><strong>Taxa de Sucesso:</strong> ${((sucessos/casosTeste.length)*100).toFixed(1)}%</li>
                    </ul>
                </div>
            `;
            
            testeDiv.innerHTML = html;
        }
        
        // An√°lise final dos dados reais do Firebase
        async function analiseFinalDados() {
            const analiseDiv = document.getElementById('analise-final');
            analiseDiv.innerHTML = '<div>üîÑ Carregando dados do Firebase...</div>';
            
            try {
                const snapshot = await db.collection('purchases').get();
                dadosCompletos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Analisar os dados
                const totalRegistros = dadosCompletos.length;
                const doacoes = dadosCompletos.filter(p => isDoacaoRobusta(p));
                const doacoesPendentes = doacoes.filter(p => isStatusPendenteRobusta(p));
                const doacoesComBotoes = dadosCompletos.filter(p => deveExibirBotoes(p));
                
                let html = `
                    <h4>üìä An√°lise dos Dados Reais</h4>
                    <div class="info" style="padding: 10px; border-radius: 4px;">
                        <ul>
                            <li><strong>Total de registros:</strong> ${totalRegistros}</li>
                            <li><strong>Doa√ß√µes identificadas:</strong> ${doacoes.length}</li>
                            <li><strong>Doa√ß√µes pendentes:</strong> ${doacoesPendentes.length}</li>
                            <li><strong>Registros que devem ter bot√µes:</strong> ${doacoesComBotoes.length}</li>
                        </ul>
                    </div>
                `;
                
                // Mostrar detalhes dos registros que devem ter bot√µes
                if (doacoesComBotoes.length > 0) {
                    html += '<h4>‚úÖ Registros que DEVEM ter bot√µes:</h4>';
                    html += '<table><thead><tr><th>ID</th><th>Tipo</th><th>Status</th><th>M√©todo/Obs</th></tr></thead><tbody>';
                    
                    doacoesComBotoes.forEach(registro => {
                        html += `
                            <tr class="highlight-success">
                                <td title="${registro.id}">${registro.id.substring(0, 8)}...</td>
                                <td>${registro.tipo || 'N/A'}</td>
                                <td>${registro.status || 'N/A'}</td>
                                <td>${registro.metodoPagamento || registro.paymentMethod || registro.observacoes || 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                }
                
                // Verificar se h√° doa√ß√µes que N√ÉO est√£o pendentes (casos problem√°ticos anteriores)
                const doacoesNaoPendentes = doacoes.filter(p => !isStatusPendenteRobusta(p));
                if (doacoesNaoPendentes.length > 0) {
                    html += '<h4>‚ö†Ô∏è Doa√ß√µes que N√ÉO t√™m bot√µes (n√£o pendentes):</h4>';
                    html += '<table><thead><tr><th>ID</th><th>Tipo</th><th>Status</th><th>Motivo</th></tr></thead><tbody>';
                    
                    doacoesNaoPendentes.forEach(registro => {
                        const motivo = `Status "${registro.status}" n√£o √© considerado pendente`;
                        html += `
                            <tr class="highlight-warning">
                                <td title="${registro.id}">${registro.id.substring(0, 8)}...</td>
                                <td>${registro.tipo || 'N/A'}</td>
                                <td>${registro.status || 'N/A'}</td>
                                <td>${motivo}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                }
                
                analiseDiv.innerHTML = html;
                
                // Atualizar resultados finais
                atualizarResultadosFinais(totalRegistros, doacoesComBotoes.length, doacoesNaoPendentes.length);
                
            } catch (error) {
                analiseDiv.innerHTML = `‚ùå Erro ao carregar dados: ${error.message}`;
            }
        }
        
        // Atualizar resultados finais
        function atualizarResultadosFinais(total, comBotoes, problem√°ticos) {
            const resultadosDiv = document.getElementById('resultados-teste');
            
            const status = problem√°ticos === 0 ? 'success' : 'warning';
            
            let html = `
                <div class="${status}" style="padding: 15px; border-radius: 4px;">
                    <h4>üéØ Resultados da Corre√ß√£o</h4>
                    <ul>
                        <li><strong>Status:</strong> ${problem√°ticos === 0 ? '‚úÖ SUCESSO TOTAL' : '‚ö†Ô∏è PARCIALMENTE RESOLVIDO'}</li>
                        <li><strong>Total de registros:</strong> ${total}</li>
                        <li><strong>Registros com bot√µes:</strong> ${comBotoes}</li>
                        <li><strong>Casos problem√°ticos restantes:</strong> ${problem√°ticos}</li>
                    </ul>
                </div>
            `;
            
            if (problem√°ticos === 0) {
                html += `
                    <div class="success" style="margin-top: 15px; padding: 15px; border-radius: 4px;">
                        <h4>üéâ PROBLEMA RESOLVIDO!</h4>
                        <p>Todos os registros de doa√ß√£o pendente agora devem exibir os bot√µes de confirma√ß√£o corretamente.</p>
                        <p><strong>As corre√ß√µes implementadas foram:</strong></p>
                        <ul>
                            <li>Normaliza√ß√£o de strings (remo√ß√£o de acentos, pontua√ß√£o, mai√∫sculas)</li>
                            <li>Verifica√ß√£o de m√∫ltiplos campos (tipo, metodoPagamento, paymentMethod, observacoes, notes)</li>
                            <li>Aceita√ß√£o de m√∫ltiplas varia√ß√µes de "doa√ß√£o" e "pendente"</li>
                            <li>L√≥gica robusta e tolerante a falhas</li>
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="warning" style="margin-top: 15px; padding: 15px; border-radius: 4px;">
                        <h4>‚ö†Ô∏è Casos Restantes</h4>
                        <p>Ainda existem ${problem√°ticos} casos de doa√ß√µes que n√£o t√™m bot√µes, mas estes s√£o doa√ß√µes que N√ÉO est√£o com status pendente.</p>
                        <p>Isso √© o comportamento correto - apenas doa√ß√µes pendentes devem ter bot√µes de confirma√ß√£o.</p>
                    </div>
                `;
            }
            
            resultadosDiv.innerHTML = html;
        }
        
        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', function() {
            console.log('üéØ P√°gina carregada, inicializando teste final...');
            initializeFirebase();
        });
    </script>
</body>
</html>
