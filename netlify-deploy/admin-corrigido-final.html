<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Admin Corrigido - Rifa Thomas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Loader espec√≠fico para verifica√ß√£o */
        .admin-loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loader-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        
        .admin-main { display: none; }
        
        .retry-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .emergency-btn {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .emergency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .auth-details {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <!-- Loader de verifica√ß√£o de autentica√ß√£o -->
    <div class="admin-loader" id="admin-loader">
        <div class="loader-content">
            <h2>üîê Verifica√ß√£o de Acesso</h2>
            <div class="spinner" id="loader-spinner"></div>
            <p id="loader-status">Conectando ao sistema...</p>
            <div id="loader-details" class="auth-details" style="display: none;"></div>
            <div id="loader-actions" style="display: none;"></div>
        </div>
    </div>

    <!-- Interface principal do admin (inicialmente oculta) -->
    <div class="admin-main" id="admin-main">
        <header class="admin-header">
            <div class="header-content">
                <h1><i class="fas fa-cog"></i> Admin - Rifa Thomas</h1>
                <div class="header-actions">
                    <span id="admin-user">Admin</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <nav class="admin-nav">
            <div class="nav-content">
                <button class="nav-btn active" onclick="showSection('dashboard')" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="nav-btn" onclick="showSection('participants')" data-section="participants">
                    <i class="fas fa-users"></i> Participantes
                </button>
                <button class="nav-btn" onclick="showSection('numbers')" data-section="numbers">
                    <i class="fas fa-list-ol"></i> N√∫meros
                </button>
                <button class="nav-btn" onclick="showSection('config')" data-section="config">
                    <i class="fas fa-cog"></i> Configura√ß√µes
                </button>
            </div>
        </nav>

        <main class="admin-content">
            <!-- Dashboard -->
            <section id="dashboard" class="admin-section active">
                <h2>üìä Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <span class="stat-number" id="total-participants">0</span>
                            <span class="stat-label">Participantes</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list-ol"></i></div>
                        <div class="stat-info">
                            <span class="stat-number" id="total-sold">0</span>
                            <span class="stat-label">N√∫meros Vendidos</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-info">
                            <span class="stat-number" id="total-revenue">R$ 0</span>
                            <span class="stat-label">Arrecada√ß√£o</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-info">
                            <span class="stat-number" id="total-pending">0</span>
                            <span class="stat-label">Pendentes</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Participantes -->
            <section id="participants" class="admin-section">
                <h2>üë• Participantes</h2>
                <div class="participants-controls">
                    <input type="text" id="search-input" placeholder="üîç Buscar participante...">
                    <button class="btn" onclick="searchParticipant()"><i class="fas fa-search"></i> Buscar</button>
                    <button class="btn" onclick="exportParticipants()"><i class="fas fa-download"></i> Exportar CSV</button>
                </div>
                <div class="participants-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>PIX</th>
                                <th>N√∫meros</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="participants-list">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">
                                    Carregando participantes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- N√∫meros -->
            <section id="numbers" class="admin-section">
                <h2>üî¢ Gerenciar N√∫meros</h2>
                <div class="numbers-grid" id="numbers-grid">
                    <!-- N√∫meros ser√£o carregados dinamicamente -->
                </div>
            </section>

            <!-- Configura√ß√µes -->
            <section id="config" class="admin-section">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <div class="config-form">
                    <div class="form-group">
                        <label for="rifa-title">T√≠tulo da Rifa:</label>
                        <input type="text" id="rifa-title" placeholder="Ex: Rifa do Ch√° de Beb√™ Thomas">
                    </div>
                    <div class="form-group">
                        <label for="rifa-description">Descri√ß√£o:</label>
                        <textarea id="rifa-description" placeholder="Descreva os pr√™mios..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="ticket-price">Pre√ßo por N√∫mero:</label>
                        <input type="number" id="ticket-price" placeholder="5.00" step="0.01">
                    </div>
                    <button class="btn" onclick="saveConfiguration()">
                        <i class="fas fa-save"></i> Salvar Configura√ß√µes
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Estado da verifica√ß√£o
        let authenticationCompleted = false;
        let currentAdminUser = null;
        let retryCount = 0;
        const maxRetries = 3;
        
        // Fun√ß√£o para log com timestamp
        function logAuth(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            
            // Atualizar detalhes visuais
            const detailsEl = document.getElementById('loader-details');
            if (detailsEl) {
                detailsEl.style.display = 'block';
                const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#007bff' };
                detailsEl.innerHTML += `<div style="color: ${colors[type] || colors.info};">[${timestamp}] ${message}</div>`;
                detailsEl.scrollTop = detailsEl.scrollHeight;
            }
        }
        
        // Atualizar status do loader
        function updateAuthStatus(message, type = 'info') {
            const statusEl = document.getElementById('loader-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = type === 'success' ? 'status-ok' : type === 'error' ? 'status-error' : '';
            }
        }
        
        // Verifica√ß√£o de autentica√ß√£o com m√∫ltiplas estrat√©gias
        async function verifyAuthentication() {
            if (authenticationCompleted) {
                logAuth('Verifica√ß√£o j√° conclu√≠da, ignorando nova tentativa', 'warning');
                return;
            }
            
            logAuth('=== INICIANDO VERIFICA√á√ÉO DE AUTENTICA√á√ÉO ===', 'info');
            updateAuthStatus('üîê Verificando autentica√ß√£o...');
            
            try {
                // Estrat√©gia 1: Verificar se FirebaseDB est√° dispon√≠vel
                await waitForFirebaseDB();
                
                // Estrat√©gia 2: Aguardar inicializa√ß√£o completa
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Estrat√©gia 3: Verificar admin atual ou fazer login
                const authResult = await performAuthCheck();
                
                if (authResult.success) {
                    logAuth(`‚úÖ Autentica√ß√£o bem-sucedida: ${authResult.user.email}`, 'success');
                    currentAdminUser = authResult.user;
                    showAdminInterface();
                } else {
                    throw new Error(authResult.error);
                }
                
            } catch (error) {
                logAuth(`‚ùå Falha na autentica√ß√£o: ${error.message}`, 'error');
                handleAuthError(error);
            }
        }
        
        // Aguardar FirebaseDB estar dispon√≠vel
        async function waitForFirebaseDB() {
            logAuth('Aguardando FirebaseDB estar dispon√≠vel...', 'info');
            
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30; // 15 segundos
                
                const check = () => {
                    if (typeof window.FirebaseDB !== 'undefined') {
                        logAuth('‚úÖ FirebaseDB dispon√≠vel', 'success');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Timeout: FirebaseDB n√£o carregou'));
                    } else {
                        attempts++;
                        updateAuthStatus(`Aguardando Firebase... (${attempts}/${maxAttempts})`);
                        setTimeout(check, 500);
                    }
                };
                
                check();
            });
        }
        
        // Realizar verifica√ß√£o de autentica√ß√£o
        async function performAuthCheck() {
            logAuth('Realizando verifica√ß√£o de autentica√ß√£o...', 'info');
            updateAuthStatus('üîç Verificando permiss√µes...');
            
            try {
                // Primeiro: verificar se j√° h√° um admin logado
                logAuth('Verificando admin atual...', 'info');
                const currentResult = await window.FirebaseDB.getCurrentAdmin();
                
                if (currentResult.success && currentResult.isAdmin) {
                    logAuth(`Admin j√° autenticado: ${currentResult.user.email}`, 'success');
                    return { success: true, user: currentResult.user };
                }
                
                // Segundo: tentar fazer login autom√°tico se n√£o h√° admin logado
                logAuth('Nenhum admin logado, tentando login autom√°tico...', 'info');
                const loginResult = await window.FirebaseDB.adminLogin('admin@rifathomas.com', 'casaVERDE123');
                
                if (loginResult.success) {
                    logAuth(`Login autom√°tico bem-sucedido: ${loginResult.user.email}`, 'success');
                    
                    // Verificar novamente ap√≥s login
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const verifyResult = await window.FirebaseDB.getCurrentAdmin();
                    
                    if (verifyResult.success && verifyResult.isAdmin) {
                        return { success: true, user: verifyResult.user };
                    } else {
                        throw new Error('Verifica√ß√£o p√≥s-login falhou');
                    }
                } else {
                    throw new Error(`Login autom√°tico falhou: ${loginResult.error}`);
                }
                
            } catch (error) {
                logAuth(`Erro na verifica√ß√£o: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }
        
        // Mostrar interface admin
        function showAdminInterface() {
            logAuth('‚úÖ Mostrando interface do administrador', 'success');
            authenticationCompleted = true;
            
            // Ocultar loader
            document.getElementById('admin-loader').style.display = 'none';
            
            // Mostrar interface principal
            document.getElementById('admin-main').style.display = 'block';
            
            // Atualizar informa√ß√µes do usu√°rio
            const userEl = document.getElementById('admin-user');
            if (userEl && currentAdminUser) {
                userEl.textContent = currentAdminUser.email;
            }
            
            // Carregar dados iniciais
            loadAdminData();
        }
        
        // Lidar com erro de autentica√ß√£o
        function handleAuthError(error) {
            logAuth(`Tratando erro de autentica√ß√£o: ${error.message}`, 'error');
            
            const actionsEl = document.getElementById('loader-actions');
            const spinnerEl = document.getElementById('loader-spinner');
            
            if (spinnerEl) spinnerEl.style.display = 'none';
            
            if (retryCount < maxRetries) {
                updateAuthStatus(`‚ùå Erro: ${error.message}`, 'error');
                
                if (actionsEl) {
                    actionsEl.style.display = 'block';
                    actionsEl.innerHTML = `
                        <button class="retry-btn" onclick="retryAuthentication()">
                            üîÑ Tentar Novamente (${retryCount + 1}/${maxRetries})
                        </button>
                        <button class="emergency-btn" onclick="useEmergencyAccess()">
                            üÜò Acesso de Emerg√™ncia
                        </button>
                    `;
                }
            } else {
                updateAuthStatus('‚ùå Falha na autentica√ß√£o ap√≥s m√∫ltiplas tentativas', 'error');
                
                if (actionsEl) {
                    actionsEl.style.display = 'block';
                    actionsEl.innerHTML = `
                        <p style="color: #dc3545; margin: 10px 0;">
                            O sistema de autentica√ß√£o n√£o est√° funcionando corretamente.
                        </p>
                        <button class="emergency-btn" onclick="useEmergencyAccess()">
                            üÜò Usar Sistema de Emerg√™ncia
                        </button>
                        <button class="retry-btn" onclick="window.location.reload()">
                            üîÑ Recarregar P√°gina
                        </button>
                    `;
                }
            }
        }
        
        // Tentar autentica√ß√£o novamente
        async function retryAuthentication() {
            retryCount++;
            authenticationCompleted = false;
            
            const spinnerEl = document.getElementById('loader-spinner');
            const actionsEl = document.getElementById('loader-actions');
            
            if (spinnerEl) spinnerEl.style.display = 'block';
            if (actionsEl) actionsEl.style.display = 'none';
            
            logAuth(`=== TENTATIVA ${retryCount} DE AUTENTICA√á√ÉO ===`, 'info');
            
            // Aguardar um pouco antes de tentar novamente
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            verifyAuthentication();
        }
        
        // Usar acesso de emerg√™ncia
        function useEmergencyAccess() {
            logAuth('Redirecionando para sistema de emerg√™ncia...', 'warning');
            window.location.href = 'admin-bypass-auth.html';
        }
        
        // Carregar dados administrativos
        async function loadAdminData() {
            logAuth('Carregando dados administrativos...', 'info');
            
            try {
                // Tentar carregar dados do Firebase primeiro
                if (typeof window.FirebaseDB !== 'undefined') {
                    const purchases = await window.FirebaseDB.loadPurchases();
                    if (purchases.success) {
                        processAdminData(purchases.purchases);
                        return;
                    }
                }
                
                // Fallback para localStorage
                const localData = localStorage.getItem('purchases');
                if (localData) {
                    const purchases = JSON.parse(localData);
                    processAdminData(purchases);
                } else {
                    logAuth('Nenhum dado encontrado', 'warning');
                }
                
            } catch (error) {
                logAuth(`Erro ao carregar dados: ${error.message}`, 'error');
            }
        }
        
        // Processar dados administrativos
        function processAdminData(purchases) {
            logAuth(`Processando ${purchases.length} compras...`, 'info');
            
            // Calcular estat√≠sticas
            const totalParticipants = new Set(purchases.map(p => `${p.name}_${p.phone}`)).size;
            const totalSold = purchases.reduce((sum, p) => sum + p.numbers.length, 0);
            const totalRevenue = totalSold * 5; // R$ 5 por n√∫mero
            const totalPending = purchases.filter(p => p.status === 'pending').length;
            
            // Atualizar dashboard
            document.getElementById('total-participants').textContent = totalParticipants;
            document.getElementById('total-sold').textContent = totalSold;
            document.getElementById('total-revenue').textContent = `R$ ${totalRevenue.toFixed(2)}`;
            document.getElementById('total-pending').textContent = totalPending;
            
            // Carregar lista de participantes
            loadParticipantsList(purchases);
            
            logAuth('‚úÖ Dados administrativos carregados', 'success');
        }
        
        // Carregar lista de participantes
        function loadParticipantsList(purchases) {
            const tbody = document.getElementById('participants-list');
            
            if (purchases.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum participante encontrado</td></tr>';
                return;
            }
            
            // Agrupar por participante
            const participants = {};
            purchases.forEach(purchase => {
                const key = `${purchase.name}_${purchase.phone}`;
                if (!participants[key]) {
                    participants[key] = {
                        name: purchase.name,
                        phone: purchase.phone,
                        pix: purchase.pix || purchase.payment || 'N/A',
                        numbers: [],
                        status: purchase.status || 'pending'
                    };
                }
                participants[key].numbers.push(...purchase.numbers);
            });
            
            // Criar HTML da tabela
            tbody.innerHTML = Object.values(participants).map(participant => `
                <tr>
                    <td><strong>${participant.name}</strong></td>
                    <td>${participant.phone}</td>
                    <td>${participant.pix}</td>
                    <td>
                        <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                            ${participant.numbers.length} n√∫meros
                        </span>
                    </td>
                    <td>
                        <span class="status ${participant.status === 'confirmed' ? 'success' : 'warning'}">
                            ${participant.status === 'confirmed' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                        </span>
                    </td>
                    <td>
                        <button class="btn" onclick="editParticipant('${participant.name}', '${participant.phone}')">
                            ‚úèÔ∏è Editar
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Navega√ß√£o entre se√ß√µes
        function showSection(sectionName) {
            // Remover classe active de todas as se√ß√µes
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ativar se√ß√£o e bot√£o correspondente
            document.getElementById(sectionName).classList.add('active');
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
        }
        
        // Fun√ß√µes administrativas b√°sicas
        function searchParticipant() {
            const query = document.getElementById('search-input').value;
            logAuth(`Buscando: ${query}`, 'info');
            // Implementar busca
        }
        
        function exportParticipants() {
            logAuth('Exportando participantes...', 'info');
            // Implementar exporta√ß√£o
        }
        
        function editParticipant(name, phone) {
            logAuth(`Editando: ${name} - ${phone}`, 'info');
            // Implementar edi√ß√£o
        }
        
        function saveConfiguration() {
            logAuth('Salvando configura√ß√µes...', 'info');
            // Implementar salvamento
        }
        
        // Logout
        async function logout() {
            logAuth('Fazendo logout...', 'info');
            
            try {
                if (typeof window.FirebaseDB !== 'undefined') {
                    await window.FirebaseDB.adminLogout();
                }
                
                // Limpar dados locais
                currentAdminUser = null;
                authenticationCompleted = false;
                
                // Redirecionar para login
                window.location.href = 'login.html';
                
            } catch (error) {
                logAuth(`Erro no logout: ${error.message}`, 'error');
                // For√ßar redirecionamento mesmo com erro
                window.location.href = 'login.html';
            }
        }
        
        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', function() {
            logAuth('Admin Corrigido iniciado', 'info');
            
            // Aguardar um pouco e iniciar verifica√ß√£o
            setTimeout(() => {
                verifyAuthentication();
            }, 1000);
        });
        
        // Aguardar evento do Firebase
        window.addEventListener('firebaseReady', () => {
            logAuth('Firebase pronto - acelerando verifica√ß√£o', 'success');
            if (!authenticationCompleted) {
                setTimeout(() => {
                    verifyAuthentication();
                }, 500);
            }
        });
        
        // Se Firebase j√° estiver pronto
        setTimeout(() => {
            if (typeof window.FirebaseDB !== 'undefined' && !authenticationCompleted) {
                logAuth('Firebase j√° dispon√≠vel', 'success');
                verifyAuthentication();
            }
        }, 2000);
    </script>
    
    <!-- Carregar script do admin ap√≥s verifica√ß√£o -->
    <script src="admin.js"></script>
</body>
</html>
