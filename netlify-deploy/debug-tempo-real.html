<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug em Tempo Real - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .debug-panel { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid; }
        .success { background: #d4edda; border-color: #28a745; color: #155724; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .log-area { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; font-family: monospace; max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.success { background: #28a745; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="debug-panel">
            <h1>ğŸ” Debug em Tempo Real - Sistema Admin</h1>
            <p>DiagnÃ³stico detalhado do erro de permissÃ£o no painel admin</p>
        </div>
        
        <div class="grid">
            <!-- Status Firebase -->
            <div class="debug-panel">
                <h3>ğŸ”¥ Status Firebase</h3>
                <div id="firebase-status" class="status info">â³ Verificando...</div>
                <button onclick="checkFirebase()">Verificar Firebase</button>
            </div>
            
            <!-- Status AutenticaÃ§Ã£o -->
            <div class="debug-panel">
                <h3>ğŸ” Status AutenticaÃ§Ã£o</h3>
                <div id="auth-status" class="status info">â³ Verificando...</div>
                <button onclick="checkAuth()">Verificar Auth</button>
            </div>
            
            <!-- Teste getCurrentAdmin -->
            <div class="debug-panel">
                <h3>ğŸ‘¤ getCurrentAdmin()</h3>
                <div id="current-admin-status" class="status info">â³ Aguardando...</div>
                <button onclick="testGetCurrentAdmin()">Testar</button>
            </div>
            
            <!-- Teste isAdmin -->
            <div class="debug-panel">
                <h3>ğŸ›¡ï¸ isAdmin(uid)</h3>
                <div id="is-admin-status" class="status info">â³ Aguardando...</div>
                <button onclick="testIsAdmin()">Testar</button>
            </div>
            
            <!-- Dados da SessÃ£o -->
            <div class="debug-panel full-width">
                <h3>ğŸ“Š Dados da SessÃ£o Atual</h3>
                <div id="session-data" class="status info">Carregando...</div>
                <button onclick="showSessionData()">Atualizar</button>
                <button onclick="clearSession()" class="danger">Limpar SessÃ£o</button>
            </div>
            
            <!-- SimulaÃ§Ã£o do Admin.html -->
            <div class="debug-panel full-width">
                <h3>ğŸ–¥ï¸ SimulaÃ§Ã£o do admin.html</h3>
                <div id="simulation-status" class="status info">Pronto para simular</div>
                <button onclick="simulateAdminPage()" class="success">Simular Carregamento do Admin</button>
                <button onclick="openRealAdmin()">ğŸš€ Abrir Admin Real</button>
            </div>
        </div>
        
        <!-- Logs em Tempo Real -->
        <div class="debug-panel">
            <h3>ğŸ“‹ Logs em Tempo Real</h3>
            <div id="real-time-logs" class="log-area">Iniciando monitoramento...\n</div>
            <button onclick="clearLogs()">Limpar</button>
            <button onclick="enableVerboseLogging()" id="verbose-btn">Ativar Log Detalhado</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        let verboseLogging = false;
        let currentUser = null;
        
        // Logging em tempo real
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('real-time-logs');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logArea.textContent += logEntry;
            logArea.scrollTop = logArea.scrollHeight;
            
            // Console tambÃ©m
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Verbose logging
            if (verboseLogging) {
                console.trace(message);
            }
        }
        
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
            log(`${elementId}: ${message}`, type);
        }
        
        // Verificar Firebase
        function checkFirebase() {
            log('Verificando disponibilidade do Firebase...');
            
            try {
                if (typeof window.FirebaseDB === 'undefined') {
                    updateStatus('firebase-status', 'âŒ FirebaseDB nÃ£o disponÃ­vel', 'error');
                    return false;
                }
                
                log(`FirebaseDB disponÃ­vel. Admin autorizado: ${window.FirebaseDB.ADMIN_AUTORIZADO}`);
                updateStatus('firebase-status', 'âœ… FirebaseDB carregado', 'success');
                
                // Verificar funÃ§Ãµes principais
                const functions = ['getCurrentAdmin', 'isAdmin', 'adminLogin', 'adminLogout'];
                functions.forEach(func => {
                    if (typeof window.FirebaseDB[func] === 'function') {
                        log(`âœ“ FunÃ§Ã£o ${func} disponÃ­vel`);
                    } else {
                        log(`âœ— FunÃ§Ã£o ${func} NÃƒO disponÃ­vel`, 'error');
                    }
                });
                
                return true;
            } catch (error) {
                log(`Erro na verificaÃ§Ã£o do Firebase: ${error.message}`, 'error');
                updateStatus('firebase-status', `âŒ Erro: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Verificar autenticaÃ§Ã£o
        async function checkAuth() {
            log('Verificando estado de autenticaÃ§Ã£o...');
            
            try {
                if (!checkFirebase()) return;
                
                // Verificar usuÃ¡rio autenticado no Firebase Auth
                const user = firebase.auth().currentUser;
                if (user) {
                    log(`UsuÃ¡rio Firebase Auth: ${user.email} (${user.uid})`);
                    currentUser = user;
                    updateStatus('auth-status', `âœ… Autenticado: ${user.email}`, 'success');
                } else {
                    log('Nenhum usuÃ¡rio autenticado no Firebase Auth');
                    updateStatus('auth-status', 'âŒ NÃ£o autenticado', 'error');
                }
                
                // Escutar mudanÃ§as de auth
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        log(`Auth changed: ${user.email} logado`);
                    } else {
                        log('Auth changed: usuÃ¡rio deslogado');
                    }
                });
                
            } catch (error) {
                log(`Erro na verificaÃ§Ã£o de auth: ${error.message}`, 'error');
                updateStatus('auth-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        // Testar getCurrentAdmin
        async function testGetCurrentAdmin() {
            log('Testando getCurrentAdmin()...');
            
            try {
                if (!window.FirebaseDB) {
                    updateStatus('current-admin-status', 'âŒ FirebaseDB nÃ£o disponÃ­vel', 'error');
                    return;
                }
                
                updateStatus('current-admin-status', 'â³ Executando getCurrentAdmin...', 'info');
                
                const result = await window.FirebaseDB.getCurrentAdmin();
                
                log(`getCurrentAdmin result: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success) {
                    if (result.isAdmin) {
                        updateStatus('current-admin-status', `âœ… Admin: ${result.user.email}`, 'success');
                        log(`getCurrentAdmin SUCESSO: ${result.user.email} Ã© admin`);
                    } else {
                        updateStatus('current-admin-status', `âŒ NÃ£o Ã© admin: ${result.user.email}`, 'error');
                        log(`getCurrentAdmin FALHA: ${result.user.email} nÃ£o Ã© admin`);
                    }
                } else {
                    updateStatus('current-admin-status', `âŒ Falha: ${result.error}`, 'error');
                    log(`getCurrentAdmin ERRO: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`Erro em getCurrentAdmin: ${error.message}`, 'error');
                updateStatus('current-admin-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        // Testar isAdmin
        async function testIsAdmin() {
            log('Testando isAdmin()...');
            
            try {
                if (!currentUser) {
                    updateStatus('is-admin-status', 'âŒ Nenhum usuÃ¡rio para testar', 'error');
                    return;
                }
                
                updateStatus('is-admin-status', 'â³ Executando isAdmin...', 'info');
                
                const isAdmin = await window.FirebaseDB.isAdmin(currentUser.uid);
                
                log(`isAdmin(${currentUser.uid}) = ${isAdmin}`);
                
                if (isAdmin) {
                    updateStatus('is-admin-status', `âœ… ${currentUser.email} Ã© admin`, 'success');
                } else {
                    updateStatus('is-admin-status', `âŒ ${currentUser.email} NÃƒO Ã© admin`, 'error');
                }
                
            } catch (error) {
                log(`Erro em isAdmin: ${error.message}`, 'error');
                updateStatus('is-admin-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        // Mostrar dados da sessÃ£o
        function showSessionData() {
            log('Coletando dados da sessÃ£o...');
            
            try {
                const data = {
                    firebaseUser: firebase.auth().currentUser ? {
                        uid: firebase.auth().currentUser.uid,
                        email: firebase.auth().currentUser.email,
                        emailVerified: firebase.auth().currentUser.emailVerified
                    } : null,
                    localStorage: Object.keys(localStorage).length > 0 ? Object.fromEntries(Object.entries(localStorage)) : 'Vazio',
                    sessionStorage: Object.keys(sessionStorage).length > 0 ? Object.fromEntries(Object.entries(sessionStorage)) : 'Vazio',
                    windowVars: {
                        FirebaseDB: typeof window.FirebaseDB !== 'undefined',
                        adminAuthApproved: window.adminAuthApproved || false
                    }
                };
                
                updateStatus('session-data', `ğŸ“Š Dados coletados (ver console)`, 'info');
                console.log('ğŸ“Š DADOS DA SESSÃƒO:', data);
                log(`Dados da sessÃ£o: ${JSON.stringify(data, null, 2)}`);
                
            } catch (error) {
                log(`Erro ao coletar dados: ${error.message}`, 'error');
                updateStatus('session-data', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        // Limpar sessÃ£o
        function clearSession() {
            if (confirm('Limpar toda a sessÃ£o? Isso farÃ¡ logout.')) {
                log('Limpando sessÃ£o...');
                try {
                    localStorage.clear();
                    sessionStorage.clear();
                    if (firebase.auth().currentUser) {
                        firebase.auth().signOut();
                    }
                    window.adminAuthApproved = false;
                    updateStatus('session-data', 'ğŸ§¹ SessÃ£o limpa', 'info');
                    log('SessÃ£o limpa com sucesso');
                } catch (error) {
                    log(`Erro ao limpar sessÃ£o: ${error.message}`, 'error');
                }
            }
        }
        
        // Simular carregamento do admin.html
        async function simulateAdminPage() {
            log('ğŸ–¥ï¸ Simulando carregamento do admin.html...');
            updateStatus('simulation-status', 'â³ Simulando...', 'info');
            
            try {
                // Etapa 1: Verificar se Firebase estÃ¡ pronto
                log('Etapa 1: Verificando Firebase...');
                if (typeof window.FirebaseDB === 'undefined') {
                    throw new Error('FirebaseDB nÃ£o disponÃ­vel');
                }
                
                // Etapa 2: Aguardar sincronizaÃ§Ã£o (como no admin.html)
                log('Etapa 2: Aguardando sincronizaÃ§Ã£o...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Etapa 3: Executar getCurrentAdmin
                log('Etapa 3: Executando getCurrentAdmin...');
                const result = await window.FirebaseDB.getCurrentAdmin();
                
                log(`Resultado getCurrentAdmin: ${JSON.stringify(result, null, 2)}`);
                
                // Etapa 4: Verificar resultado (exatamente como admin.html)
                if (!result.success) {
                    throw new Error(`getCurrentAdmin falhou: ${result.error}`);
                }
                
                if (!result.isAdmin) {
                    throw new Error('UsuÃ¡rio nÃ£o tem permissÃµes de admin');
                }
                
                // Etapa 5: Sucesso
                log('âœ… SimulaÃ§Ã£o bem-sucedida! UsuÃ¡rio tem permissÃµes de admin');
                updateStatus('simulation-status', 'âœ… SimulaÃ§Ã£o OK - Admin autorizado', 'success');
                
            } catch (error) {
                log(`âŒ SimulaÃ§Ã£o falhou: ${error.message}`, 'error');
                updateStatus('simulation-status', `âŒ Falha: ${error.message}`, 'error');
            }
        }
        
        // Abrir admin real
        function openRealAdmin() {
            log('Abrindo admin.html real...');
            window.open('admin.html', '_blank');
        }
        
        // UtilitÃ¡rios
        function clearLogs() {
            document.getElementById('real-time-logs').textContent = 'Logs limpos.\n';
        }
        
        function enableVerboseLogging() {
            verboseLogging = !verboseLogging;
            const btn = document.getElementById('verbose-btn');
            btn.textContent = verboseLogging ? 'Desativar Log Detalhado' : 'Ativar Log Detalhado';
            btn.style.background = verboseLogging ? '#dc3545' : '#007bff';
            log(`Verbose logging ${verboseLogging ? 'ativado' : 'desativado'}`);
        }
        
        // Auto-inicializaÃ§Ã£o
        window.addEventListener('firebaseReady', () => {
            log('ğŸ”¥ FirebaseReady event recebido');
            setTimeout(() => {
                checkFirebase();
                checkAuth();
            }, 500);
        });
        
        // Se Firebase jÃ¡ estiver pronto
        if (typeof window.FirebaseDB !== 'undefined') {
            log('ğŸ”¥ Firebase jÃ¡ disponÃ­vel na inicializaÃ§Ã£o');
            setTimeout(() => {
                checkFirebase();
                checkAuth();
            }, 500);
        }
        
        // InicializaÃ§Ã£o
        log('ğŸš€ Debug em tempo real iniciado');
    </script>
</body>
</html>
