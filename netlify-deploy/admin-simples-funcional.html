<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Rifa Thomas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* Estilo para loader de verifica√ß√£o */
        .verification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .verification-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            color: #155724;
            background: #d4edda;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <!-- Overlay de verifica√ß√£o -->
    <div id="verification-overlay" class="verification-overlay">
        <div class="verification-content">
            <h2>üîê Verificando Permiss√µes de Administrador</h2>
            <div class="spinner"></div>
            <p id="verification-message">Validando suas credenciais...</p>
            <div id="verification-details" style="font-size: 14px; color: #666; margin-top: 15px;">
                Aguarde enquanto verificamos suas permiss√µes de acesso
            </div>
        </div>
    </div>

    <!-- Conte√∫do principal (oculto inicialmente) -->
    <div id="main-content" style="display: none;">
        <header>
            <nav class="navbar">
                <div class="nav-container">
                    <h1 class="logo"><i class="fas fa-rocket"></i> Admin - Ch√° Rifa Thomas</h1>
                    <ul class="nav-menu">
                        <li><a href="index.html">‚Üê Voltar ao Site</a></li>
                        <li><a href="#dashboard">Dashboard</a></li>
                        <li><a href="#participantes">Participantes</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <main class="admin-main">
            <!-- Dashboard -->
            <section id="dashboard" class="admin-section">
                <div class="container">
                    <h2>Dashboard - Ch√° Rifa Thomas üöÄ</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-sold">0</h3>
                                <p>N√∫meros Vendidos</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-revenue">R$ 0,00</h3>
                                <p>Faturamento</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="total-participants">0</h3>
                                <p>Participantes</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="percentage-sold">0%</h3>
                                <p>Vendidos</p>
                            </div>
                        </div>
                    </div>

                    <div class="admin-actions">
                        <button onclick="refreshData()" class="action-btn">
                            <i class="fas fa-sync-alt"></i> Atualizar Dados
                        </button>
                        <button onclick="exportData()" class="action-btn">
                            <i class="fas fa-download"></i> Exportar Relat√≥rio
                        </button>
                        <button onclick="openDrawModal()" class="action-btn special">
                            <i class="fas fa-trophy"></i> Realizar Sorteio
                        </button>
                    </div>
                </div>
            </section>

            <!-- Participantes -->
            <section id="participantes" class="admin-section">
                <div class="container">
                    <h2>Participantes</h2>
                    
                    <div class="participants-table-container">
                        <table class="participants-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>WhatsApp</th>
                                    <th>N√∫meros</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="participants-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                        üìä Carregando dados dos participantes...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Configura√ß√µes -->
            <section id="configuracoes" class="admin-section">
                <div class="container">
                    <h2>Configura√ß√µes da Rifa</h2>
                    
                    <form id="config-form" class="config-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="config-total-numbers">Total de N√∫meros:</label>
                                <input type="number" id="config-total-numbers" min="100" max="10000" value="150">
                            </div>
                            <div class="form-group">
                                <label for="config-ticket-price">Pre√ßo do Bilhete (R$):</label>
                                <input type="number" id="config-ticket-price" min="1" step="0.01" value="40.00">
                            </div>
                        </div>
                        
                        <button type="submit" class="save-config-btn">
                            <i class="fas fa-save"></i> Salvar Configura√ß√µes
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        // Sistema de verifica√ß√£o simplificado e direto
        let verificationStep = 0;
        let verificationSteps = [
            'Conectando ao Firebase...',
            'Verificando autentica√ß√£o...',
            'Validando permiss√µes de administrador...',
            'Carregando painel administrativo...'
        ];
        
        // Fun√ß√£o para atualizar status de verifica√ß√£o
        function updateVerificationStatus(message, isError = false) {
            const messageEl = document.getElementById('verification-message');
            const detailsEl = document.getElementById('verification-details');
            
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.style.color = isError ? '#dc3545' : '#007bff';
            }
            
            if (detailsEl && verificationStep < verificationSteps.length) {
                detailsEl.textContent = verificationSteps[verificationStep];
                verificationStep++;
            }
            
            console.log(`VERIFICA√á√ÉO: ${message}`);
        }
        
        // Fun√ß√£o para esconder overlay e mostrar conte√∫do
        function showMainContent(userEmail) {
            const overlay = document.getElementById('verification-overlay');
            const mainContent = document.getElementById('main-content');
            
            if (overlay) overlay.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
            
            // Adicionar informa√ß√µes do admin
            const adminInfo = document.createElement('div');
            adminInfo.innerHTML = `
                <div style="position: fixed; top: 10px; right: 10px; background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 12px 20px; border-radius: 8px; z-index: 9999; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span><i class="fas fa-user-shield"></i> ${userEmail}</span>
                        <button onclick="performLogout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(adminInfo);
            
            // Ajustar margem do body
            document.body.style.paddingTop = '60px';
            
            console.log('‚úÖ Painel administrativo carregado com sucesso');
        }
        
        // Fun√ß√£o para mostrar erro e redirecionar
        function showErrorAndRedirect(errorMessage) {
            const verificationContent = document.querySelector('.verification-content');
            if (verificationContent) {
                verificationContent.innerHTML = `
                    <h2 style="color: #dc3545;">‚ùå Acesso Negado</h2>
                    <div class="error-message">
                        <strong>Erro:</strong> ${errorMessage}
                    </div>
                    <p>Voc√™ ser√° redirecionado para a p√°gina de login...</p>
                    <button onclick="window.location.href='login.html'" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                        üîê Ir para Login
                    </button>
                `;
            }
            
            // Redirecionar ap√≥s 3 segundos
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 3000);
        }
        
        // Fun√ß√£o principal de verifica√ß√£o
        async function verifyAdminAccess() {
            try {
                updateVerificationStatus('Iniciando verifica√ß√£o...');
                
                // Passo 1: Verificar se Firebase est√° dispon√≠vel
                if (typeof window.FirebaseDB === 'undefined') {
                    console.log('‚è≥ Firebase n√£o carregado ainda, aguardando...');
                    return; // Ser√° chamado novamente quando Firebase carregar
                }
                
                updateVerificationStatus('Firebase conectado ‚úì');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Passo 2: Verificar autentica√ß√£o
                updateVerificationStatus('Verificando autentica√ß√£o...');
                
                // Aguardar estado de auth estabilizar
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const currentAdminResult = await window.FirebaseDB.getCurrentAdmin();
                
                console.log('üìä Resultado getCurrentAdmin:', currentAdminResult);
                
                if (!currentAdminResult.success) {
                    throw new Error(currentAdminResult.error || 'Falha na verifica√ß√£o de autentica√ß√£o');
                }
                
                updateVerificationStatus('Autentica√ß√£o verificada ‚úì');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Passo 3: Verificar permiss√µes de admin
                updateVerificationStatus('Validando permiss√µes...');
                
                if (!currentAdminResult.isAdmin) {
                    throw new Error('Usu√°rio n√£o possui permiss√µes de administrador');
                }
                
                // Verifica√ß√£o dupla com isAdmin
                const isAdminCheck = await window.FirebaseDB.isAdmin(currentAdminResult.user.uid);
                if (!isAdminCheck) {
                    throw new Error('Falha na verifica√ß√£o dupla de permiss√µes');
                }
                
                updateVerificationStatus('Permiss√µes validadas ‚úì');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Passo 4: Carregar painel
                updateVerificationStatus('Carregando painel administrativo...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Sucesso! Mostrar painel
                showMainContent(currentAdminResult.user.email);
                
                // Inicializar dados do painel
                setTimeout(initializeAdminData, 500);
                
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o de admin:', error);
                showErrorAndRedirect(error.message);
            }
        }
        
        // Fun√ß√£o de logout
        async function performLogout() {
            if (confirm('Tem certeza que deseja sair do painel administrativo?')) {
                try {
                    const result = await window.FirebaseDB.adminLogout();
                    if (result.success) {
                        window.location.href = 'login.html';
                    } else {
                        alert('Erro no logout: ' + result.error);
                    }
                } catch (error) {
                    console.error('Erro no logout:', error);
                    alert('Erro inesperado no logout');
                }
            }
        }
        
        // Inicializar dados do painel (simplificado)
        async function initializeAdminData() {
            try {
                console.log('üìä Carregando dados do painel...');
                
                // Carregar estat√≠sticas
                const stats = await window.FirebaseDB.getStats();
                if (stats.success) {
                    const data = stats.data;
                    document.getElementById('total-sold').textContent = data.totalSold || 0;
                    document.getElementById('total-revenue').textContent = `R$ ${(data.totalRevenue || 0).toFixed(2).replace('.', ',')}`;
                    document.getElementById('total-participants').textContent = data.totalPurchases || 0;
                    
                    const percentage = ((data.totalSold || 0) / 150 * 100).toFixed(1);
                    document.getElementById('percentage-sold').textContent = `${percentage}%`;
                }
                
                // Carregar participantes
                const purchases = await window.FirebaseDB.loadPurchases();
                if (purchases.success) {
                    updateParticipantsTable(purchases.data);
                }
                
                console.log('‚úÖ Dados do painel carregados');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
            }
        }
        
        // Atualizar tabela de participantes (simplificado)
        function updateParticipantsTable(purchases) {
            const tbody = document.getElementById('participants-tbody');
            if (!tbody || !purchases) return;
            
            if (purchases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            üìù Nenhum participante encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = purchases.slice(0, 10).map(purchase => {
                const status = purchase.status === 'confirmed' ? 'Confirmado' : 
                              purchase.status === 'pending' ? 'Pendente' : 'Cancelado';
                const statusClass = purchase.status === 'confirmed' ? 'success' : 
                                   purchase.status === 'pending' ? 'warning' : 'danger';
                
                return `
                    <tr>
                        <td>${purchase.buyerName || 'N/A'}</td>
                        <td>${purchase.buyerPhone || 'N/A'}</td>
                        <td>${purchase.numbers ? purchase.numbers.slice(0,3).join(', ') + (purchase.numbers.length > 3 ? '...' : '') : 'N/A'}</td>
                        <td>R$ ${(purchase.totalAmount || 0).toFixed(2).replace('.', ',')}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>${purchase.timestamp ? new Date(purchase.timestamp.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td>
                            <button onclick="alert('Funcionalidade em desenvolvimento')" style="padding: 5px 10px; border: none; background: #007bff; color: white; border-radius: 3px; cursor: pointer;">
                                Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Fun√ß√µes do painel (simplificadas)
        function refreshData() {
            console.log('üîÑ Atualizando dados...');
            initializeAdminData();
        }
        
        function exportData() {
            alert('üìä Funcionalidade de exporta√ß√£o em desenvolvimento');
        }
        
        function openDrawModal() {
            alert('üèÜ Funcionalidade de sorteio em desenvolvimento');
        }
        
        // Event listeners
        window.addEventListener('firebaseReady', () => {
            console.log('üî• Firebase carregado, iniciando verifica√ß√£o...');
            setTimeout(verifyAdminAccess, 500);
        });
        
        // Se Firebase j√° estiver carregado
        if (typeof window.FirebaseDB !== 'undefined') {
            console.log('üî• Firebase j√° dispon√≠vel');
            setTimeout(verifyAdminAccess, 500);
        }
        
        // Timeout de seguran√ßa
        setTimeout(() => {
            if (document.getElementById('verification-overlay').style.display !== 'none') {
                console.log('‚è∞ Timeout na verifica√ß√£o');
                showErrorAndRedirect('Timeout na verifica√ß√£o de permiss√µes. Verifique sua conex√£o.');
            }
        }, 20000);
        
        console.log('üöÄ Admin simplificado iniciado');
    </script>
</body>
</html>
