<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Teste Final - ConfirmaÃ§Ã£o Funcionando</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); }
        .step { background: rgba(255,255,255,0.2); padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 4px solid #00ff88; }
        .step h3 { margin-top: 0; color: #00ff88; }
        button { background: linear-gradient(45deg, #00ff88, #00cc6a); color: white; padding: 15px 30px; border: none; border-radius: 25px; cursor: pointer; margin: 10px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,255,136,0.3); transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,255,136,0.4); }
        .red { background: linear-gradient(45deg, #ff4757, #c44569); box-shadow: 0 4px 15px rgba(255,71,87,0.3); }
        .red:hover { box-shadow: 0 6px 20px rgba(255,71,87,0.4); }
        .status { padding: 15px; margin: 10px 0; border-radius: 10px; }
        .success { background: rgba(0,255,136,0.2); border: 1px solid #00ff88; }
        .error { background: rgba(255,71,87,0.2); border: 1px solid #ff4757; }
        .info { background: rgba(116,185,255,0.2); border: 1px solid #74b9ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Teste Final - ConfirmaÃ§Ã£o de Pendentes</h1>
        <p>Vamos testar se a correÃ§Ã£o funcionou de verdade!</p>
        
        <div class="step">
            <h3>ğŸ“‹ Passo 1: Preparar Dados</h3>
            <p>Primeiro, vamos criar dados de teste frescos com doaÃ§Ãµes pendentes.</p>
            <button onclick="prepareTestData()">ğŸ†• Criar Dados de Teste</button>
            <div id="step1-status"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”— Passo 2: Abrir Admin</h3>
            <p>Abrir o admin em uma nova aba para teste manual.</p>
            <button onclick="openAdmin()">ğŸš€ Abrir Admin</button>
            <div id="step2-status"></div>
        </div>
        
        <div class="step">
            <h3>âœ… Passo 3: Teste Manual</h3>
            <p>Na pÃ¡gina admin que abriu:</p>
            <ol>
                <li>Clique no filtro <strong>"ğŸ¼ DoaÃ§Ãµes Pendentes"</strong></li>
                <li>VocÃª deve ver as doaÃ§Ãµes pendentes listadas</li>
                <li>Clique no botÃ£o <strong>"âœ… Confirmar"</strong> de uma doaÃ§Ã£o</li>
                <li>Confirme no popup</li>
                <li>A doaÃ§Ã£o deve sair da lista de pendentes!</li>
            </ol>
            <button onclick="checkResults()">ğŸ” Verificar Resultados</button>
            <div id="step3-status"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ§¹ Limpeza</h3>
            <p>Limpar dados de teste quando terminar.</p>
            <button onclick="cleanUp()" class="red">ğŸ—‘ï¸ Limpar Dados</button>
            <div id="cleanup-status"></div>
        </div>
        
        <div id="console-output" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-top: 20px; font-family: monospace; font-size: 14px; max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#00ff88' : type === 'error' ? '#ff4757' : '#74b9ff';
            
            output.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStatus(stepId, message, type = 'info') {
            const element = document.getElementById(stepId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<div class="status ${className}">${message}</div>`;
        }
        
        function prepareTestData() {
            log('ğŸ†• Criando dados de teste para confirmaÃ§Ã£o...', 'info');
            
            try {
                const testData = [
                    {
                        id: 'pending_test_001',
                        name: 'ğŸ‘¤ Maria Silva (TESTE PENDENTE)',
                        buyerName: 'Maria Silva',
                        phone: '(11) 99999-1111',
                        buyerPhone: '(11) 99999-1111',
                        numbers: [1, 2, 3],
                        totalAmount: 120.00,
                        paymentMethod: 'doacao',
                        status: 'pending_donation',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    },
                    {
                        id: 'pending_test_002',
                        name: 'ğŸ‘¤ JoÃ£o Santos (TESTE PENDENTE)',
                        buyerName: 'JoÃ£o Santos',
                        phone: '(11) 99999-2222',
                        buyerPhone: '(11) 99999-2222',
                        numbers: [4, 5, 6],
                        totalAmount: 120.00,
                        paymentMethod: 'doacao',
                        status: 'pending_donation',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    },
                    {
                        id: 'confirmed_test_001',
                        name: 'ğŸ‘¤ Ana Costa (JÃ CONFIRMADO)',
                        buyerName: 'Ana Costa',
                        phone: '(11) 99999-3333',
                        buyerPhone: '(11) 99999-3333',
                        numbers: [7, 8, 9],
                        totalAmount: 120.00,
                        paymentMethod: 'pix',
                        status: 'confirmed',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('purchases', JSON.stringify(testData));
                
                log('âœ… Dados de teste criados com sucesso!', 'success');
                log(`ğŸ“Š Total: ${testData.length} compras`, 'info');
                log(`ğŸ¼ Pendentes: 2 doaÃ§Ãµes`, 'info');
                log(`âœ… Confirmados: 1 compra`, 'info');
                
                updateStatus('step1-status', 'âœ… Dados de teste criados com sucesso! 2 doaÃ§Ãµes pendentes prontas para teste.', 'success');
                
            } catch (error) {
                log(`âŒ Erro ao criar dados: ${error.message}`, 'error');
                updateStatus('step1-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        function openAdmin() {
            log('ğŸš€ Abrindo admin em nova aba...', 'info');
            
            const adminWindow = window.open('admin.html', '_blank', 'width=1200,height=800');
            
            if (adminWindow) {
                log('âœ… Admin aberto em nova aba!', 'success');
                updateStatus('step2-status', 'âœ… Admin aberto! Agora teste manualmente na nova aba.', 'success');
                
                log('ğŸ“ INSTRUÃ‡Ã•ES PARA TESTE:', 'info');
                log('1. Aguarde o admin carregar completamente', 'info');
                log('2. Clique no filtro "ğŸ¼ DoaÃ§Ãµes Pendentes"', 'info');
                log('3. Deve mostrar 2 doaÃ§Ãµes pendentes', 'info');
                log('4. Clique "âœ… Confirmar" em uma delas', 'info');
                log('5. Confirme no popup', 'info');
                log('6. A doaÃ§Ã£o deve sair da lista!', 'info');
                
            } else {
                log('âŒ Falha ao abrir admin - popup bloqueado?', 'error');
                updateStatus('step2-status', 'âŒ Falha ao abrir admin. Verifique se popups estÃ£o habilitados.', 'error');
            }
        }
        
        function checkResults() {
            log('ğŸ” Verificando resultados do teste...', 'info');
            
            try {
                const purchases = localStorage.getItem('purchases');
                if (!purchases) {
                    log('âŒ Nenhum dado encontrado', 'error');
                    updateStatus('step3-status', 'âŒ Nenhum dado encontrado. Execute o Passo 1 primeiro.', 'error');
                    return;
                }
                
                const data = JSON.parse(purchases);
                
                const stats = {
                    total: data.length,
                    pending: data.filter(p => p.status === 'pending_donation').length,
                    confirmed: data.filter(p => p.status === 'confirmed').length,
                    rejected: data.filter(p => p.status === 'rejected').length
                };
                
                log('ğŸ“Š Resultados atuais:', 'info');
                log(`ğŸ“‹ Total de compras: ${stats.total}`, 'info');
                log(`ğŸ¼ Pendentes: ${stats.pending}`, 'info');
                log(`âœ… Confirmados: ${stats.confirmed}`, 'info');
                log(`âŒ Rejeitados: ${stats.rejected}`, 'info');
                
                // Verificar se houve confirmaÃ§Ãµes
                const confirmedItems = data.filter(p => p.status === 'confirmed' && p.confirmedAt);
                
                if (confirmedItems.length > 1) { // Original tinha 1, se tem mais Ã© porque confirmou
                    log('ğŸ‰ SUCESSO! Detectadas confirmaÃ§Ãµes feitas pelo admin!', 'success');
                    updateStatus('step3-status', 'ğŸ‰ TESTE PASSOU! ConfirmaÃ§Ãµes funcionando corretamente!', 'success');
                    
                    confirmedItems.forEach(item => {
                        if (item.confirmedAt) {
                            log(`âœ… ${item.name} - confirmado em ${new Date(item.confirmedAt).toLocaleString()}`, 'success');
                        }
                    });
                    
                } else if (stats.pending === 2) {
                    log('âš ï¸ Ainda hÃ¡ 2 pendentes. Teste ainda nÃ£o foi executado.', 'info');
                    updateStatus('step3-status', 'âš ï¸ Ainda hÃ¡ 2 pendentes. Execute o teste manual no admin.', 'info');
                    
                } else {
                    log('âœ… MudanÃ§as detectadas nos dados!', 'success');
                    updateStatus('step3-status', 'âœ… MudanÃ§as detectadas! Verifique os logs.', 'success');
                }
                
            } catch (error) {
                log(`âŒ Erro ao verificar: ${error.message}`, 'error');
                updateStatus('step3-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        function cleanUp() {
            if (!confirm('ğŸ—‘ï¸ Limpar todos os dados de teste?')) {
                return;
            }
            
            try {
                localStorage.clear();
                log('âœ… Dados limpos com sucesso!', 'success');
                updateStatus('cleanup-status', 'âœ… Dados de teste removidos.', 'success');
                
            } catch (error) {
                log(`âŒ Erro ao limpar: ${error.message}`, 'error');
                updateStatus('cleanup-status', `âŒ Erro: ${error.message}`, 'error');
            }
        }
        
        // Verificar dados existentes ao carregar
        setTimeout(() => {
            const purchases = localStorage.getItem('purchases');
            if (purchases) {
                const data = JSON.parse(purchases);
                log(`ğŸ“‹ Dados existentes encontrados: ${data.length} compras`, 'info');
            } else {
                log('ğŸ“­ Nenhum dado existente. Execute o Passo 1 para comeÃ§ar.', 'info');
            }
        }, 500);
    </script>
</body>
</html>
