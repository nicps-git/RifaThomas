<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Final - Permiss√£o Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .error { background: #ffe8e8; border-color: #f44336; color: #c62828; }
        .warning { background: #fff3e0; border-color: #ff9800; color: #ef6c00; }
        .info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; margin: 10px 0; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug Final - Permiss√£o de Administrador</h1>
        <p>Esta p√°gina vai diagnosticar exatamente onde est√° o problema de permiss√£o.</p>
        
        <!-- Status do Firebase -->
        <div id="firebase-status" class="status info">
            ‚è≥ Aguardando Firebase...
        </div>
        
        <!-- Status da Autentica√ß√£o -->
        <div id="auth-status" class="status info">
            ‚è≥ Verificando autentica√ß√£o...
        </div>
        
        <!-- Status das Permiss√µes -->
        <div id="permission-status" class="status info">
            ‚è≥ Aguardando verifica√ß√£o de permiss√µes...
        </div>
        
        <!-- Dados do Usu√°rio -->
        <div id="user-data" class="status info">
            ‚è≥ Carregando dados do usu√°rio...
        </div>
        
        <!-- √Årea de Teste -->
        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 5px;">
            <h3>Teste Manual de Login</h3>
            <input type="email" id="test-email" placeholder="Email (admin@rifathomas.com)" value="admin@rifathomas.com">
            <input type="password" id="test-password" placeholder="Senha (casaVERDE123)" value="casaVERDE123">
            <br>
            <button onclick="testLogin()">üîê Testar Login</button>
            <button onclick="testLogout()">üö™ Testar Logout</button>
            <button onclick="checkCurrentUser()">üë§ Verificar Usu√°rio Atual</button>
            <button onclick="cleanAuth()">üßπ Limpar Autentica√ß√£o</button>
        </div>
        
        <!-- Logs Detalhados -->
        <div style="margin: 20px 0;">
            <h3>üìã Logs Detalhados</h3>
            <div id="detailed-logs" class="code-block">
                Aguardando logs...
            </div>
        </div>
        
        <!-- Corre√ß√£o Autom√°tica -->
        <div style="margin: 20px 0; padding: 20px; background: #fff3e0; border-radius: 5px;">
            <h3>üîß Corre√ß√£o Autom√°tica</h3>
            <p>Se detectarmos problemas, tentaremos corrigi-los automaticamente.</p>
            <button onclick="autoFix()">üîß Executar Corre√ß√£o Autom√°tica</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateLogsDisplay();
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        function updateLogsDisplay() {
            document.getElementById('detailed-logs').textContent = logs.join('\n');
        }
        
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            addLog(`${elementId}: ${message}`, type);
        }
        
        // Verificar Firebase
        function checkFirebase() {
            addLog('Verificando disponibilidade do Firebase...');
            
            if (typeof window.FirebaseDB === 'undefined') {
                updateStatus('firebase-status', '‚ùå FirebaseDB n√£o est√° dispon√≠vel', 'error');
                return false;
            }
            
            updateStatus('firebase-status', '‚úÖ FirebaseDB carregado com sucesso', 'success');
            addLog(`Admin autorizado: ${window.FirebaseDB.ADMIN_AUTORIZADO}`);
            return true;
        }
        
        // Verificar autentica√ß√£o atual
        async function checkCurrentUser() {
            addLog('Verificando usu√°rio atual...');
            
            if (!checkFirebase()) return;
            
            try {
                const result = await window.FirebaseDB.getCurrentAdmin();
                
                if (result.success) {
                    updateStatus('auth-status', `‚úÖ Usu√°rio autenticado: ${result.user.email}`, 'success');
                    updateStatus('user-data', `üë§ UID: ${result.user.uid} | Email: ${result.user.email} | Admin: ${result.isAdmin}`, 'success');
                    
                    // Verificar permiss√µes espec√≠ficas
                    const isAdmin = await window.FirebaseDB.isAdmin(result.user.uid);
                    updateStatus('permission-status', `üîê Permiss√£o de admin: ${isAdmin ? 'SIM' : 'N√ÉO'}`, isAdmin ? 'success' : 'error');
                } else {
                    updateStatus('auth-status', `‚ùå N√£o autenticado: ${result.error}`, 'error');
                    updateStatus('user-data', '‚ùå Nenhum usu√°rio logado', 'error');
                    updateStatus('permission-status', '‚ùå Sem permiss√µes', 'error');
                }
            } catch (error) {
                addLog(`Erro na verifica√ß√£o: ${error.message}`, 'error');
                updateStatus('auth-status', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // Testar login
        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            addLog(`Tentando login com: ${email}`);
            
            if (!checkFirebase()) return;
            
            try {
                updateStatus('auth-status', '‚è≥ Fazendo login...', 'info');
                
                const result = await window.FirebaseDB.adminLogin(email, password);
                
                if (result.success) {
                    updateStatus('auth-status', `‚úÖ Login bem-sucedido: ${result.user.email}`, 'success');
                    addLog(`Login realizado: ${result.user.uid}`);
                    
                    // Aguardar um pouco e verificar permiss√µes
                    setTimeout(async () => {
                        await checkCurrentUser();
                    }, 1000);
                } else {
                    updateStatus('auth-status', `‚ùå Falha no login: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`Erro no login: ${error.message}`, 'error');
                updateStatus('auth-status', `‚ùå Erro no login: ${error.message}`, 'error');
            }
        }
        
        // Testar logout
        async function testLogout() {
            addLog('Tentando logout...');
            
            if (!checkFirebase()) return;
            
            try {
                const result = await window.FirebaseDB.adminLogout();
                
                if (result.success) {
                    updateStatus('auth-status', '‚úÖ Logout realizado', 'success');
                    updateStatus('user-data', '‚ùå Nenhum usu√°rio logado', 'info');
                    updateStatus('permission-status', '‚ùå Sem permiss√µes', 'info');
                } else {
                    updateStatus('auth-status', `‚ùå Erro no logout: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`Erro no logout: ${error.message}`, 'error');
            }
        }
        
        // Limpar autentica√ß√£o
        async function cleanAuth() {
            addLog('Limpando estado de autentica√ß√£o...');
            
            try {
                // Limpar localStorage
                localStorage.clear();
                sessionStorage.clear();
                
                // Fazer logout do Firebase
                if (typeof firebase !== 'undefined' && firebase.auth()) {
                    await firebase.auth().signOut();
                }
                
                // Limpar dados n√£o autorizados
                if (window.FirebaseDB && window.FirebaseDB.cleanUnauthorizedAdmins) {
                    const cleanResult = await window.FirebaseDB.cleanUnauthorizedAdmins();
                    addLog(`Limpeza de admins: ${JSON.stringify(cleanResult)}`);
                }
                
                updateStatus('auth-status', 'üßπ Estado de autentica√ß√£o limpo', 'info');
                updateStatus('user-data', '‚ùå Nenhum usu√°rio logado', 'info');
                updateStatus('permission-status', '‚ùå Sem permiss√µes', 'info');
                
                addLog('Limpeza conclu√≠da');
            } catch (error) {
                addLog(`Erro na limpeza: ${error.message}`, 'error');
            }
        }
        
        // Corre√ß√£o autom√°tica
        async function autoFix() {
            addLog('Iniciando corre√ß√£o autom√°tica...');
            
            if (!checkFirebase()) {
                addLog('N√£o √© poss√≠vel corrigir sem Firebase', 'error');
                return;
            }
            
            try {
                // 1. Limpar estado
                await cleanAuth();
                
                // 2. Aguardar um pouco
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 3. Tentar criar/logar admin
                const email = 'admin@rifathomas.com';
                const password = 'casaVERDE123';
                
                addLog('Tentando criar/logar admin automaticamente...');
                
                let result = await window.FirebaseDB.createAdmin(email, password);
                
                if (!result.success && result.error.includes('j√° existe')) {
                    addLog('Admin j√° existe, tentando login...');
                    result = await window.FirebaseDB.adminLogin(email, password);
                }
                
                if (result.success) {
                    addLog('Corre√ß√£o bem-sucedida!', 'success');
                    setTimeout(async () => {
                        await checkCurrentUser();
                    }, 1000);
                } else {
                    addLog(`Corre√ß√£o falhou: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`Erro na corre√ß√£o autom√°tica: ${error.message}`, 'error');
            }
        }
        
        // Aguardar Firebase estar pronto
        window.addEventListener('firebaseReady', () => {
            addLog('Firebase carregado, iniciando verifica√ß√µes...');
            checkFirebase();
            checkCurrentUser();
        });
        
        // Se Firebase j√° estiver pronto
        if (typeof window.FirebaseDB !== 'undefined') {
            addLog('Firebase j√° dispon√≠vel, iniciando verifica√ß√µes...');
            checkFirebase();
            checkCurrentUser();
        }
        
        // Timeout de seguran√ßa
        setTimeout(() => {
            if (typeof window.FirebaseDB === 'undefined') {
                updateStatus('firebase-status', '‚ùå Timeout - Firebase n√£o carregou', 'error');
                addLog('Firebase n√£o carregou dentro do tempo esperado', 'error');
            }
        }, 10000);
    </script>
</body>
</html>
