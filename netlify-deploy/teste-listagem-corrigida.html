<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste - Listagem de Participantes Corrigida</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-panel {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-ok { color: #28a745; font-weight: bold; }
        .status-error { color: #dc3545; font-weight: bold; }
        .status-warning { color: #ffc107; font-weight: bold; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            background: #f8f9fa; 
            font-weight: bold;
        }
        
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-btn:hover { background: #0056b3; }
        .test-btn.success { background: #28a745; }
        .test-btn.error { background: #dc3545; }
        .test-btn.warning { background: #ffc107; color: black; }
        
        .participants-table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .action-buttons button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-confirmed { background: #28a745; }
        .status-pending-donation { background: #ffc107; color: black; }
        .status-rejected { background: #dc3545; }
    </style>
</head>
<body>
    <h1>üîß Teste - Listagem de Participantes Corrigida</h1>
    
    <div class="test-panel">
        <h2>üìã Status da Corre√ß√£o</h2>
        <div id="status-info">
            <div>üîÑ Verificando sistema...</div>
        </div>
    </div>

    <div class="test-panel">
        <h2>üß™ Testes Funcionais</h2>
        <button class="test-btn" onclick="testeCarregarFuncoes()">1Ô∏è‚É£ Verificar Fun√ß√µes</button>
        <button class="test-btn" onclick="testeCriarDados()">2Ô∏è‚É£ Criar Dados de Teste</button>
        <button class="test-btn" onclick="testeCarregarParticipantes()">3Ô∏è‚É£ Carregar Participantes</button>
        <button class="test-btn" onclick="testeFormatacao()">4Ô∏è‚É£ Testar Formata√ß√£o</button>
        <button class="test-btn" onclick="testeBotoes()">5Ô∏è‚É£ Testar Bot√µes</button>
        <button class="test-btn" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
        
        <div id="test-output" class="log-output"></div>
    </div>

    <div class="test-panel">
        <h2>üë• Tabela de Participantes</h2>
        <div class="participants-table-container">
            <table class="participants-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>WhatsApp</th>
                        <th>N√∫meros</th>
                        <th>Valor</th>
                        <th>M√©todo</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="participants-tbody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            üîç Aguardando testes...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scripts -->
    <script src="firebase-config.js"></script>
    <script src="admin.js"></script>
    
    <script>
        let testLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testLog.push(logMessage);
            
            const output = document.getElementById('test-output');
            const div = document.createElement('div');
            div.textContent = logMessage;
            div.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#333';
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            
            console.log(logMessage);
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status-info');
            let status = [];
            
            // Verificar adminData
            if (typeof window.adminData !== 'undefined') {
                status.push('<span class="status-ok">‚úÖ adminData: Dispon√≠vel</span>');
            } else {
                status.push('<span class="status-error">‚ùå adminData: N√£o dispon√≠vel</span>');
            }
            
            // Verificar loadParticipants
            if (typeof window.loadParticipants === 'function') {
                status.push('<span class="status-ok">‚úÖ loadParticipants: Fun√ß√£o dispon√≠vel</span>');
            } else {
                status.push('<span class="status-error">‚ùå loadParticipants: Fun√ß√£o n√£o encontrada</span>');
            }
            
            // Verificar formatCurrency
            if (typeof window.formatCurrency === 'function') {
                status.push('<span class="status-ok">‚úÖ formatCurrency: Fun√ß√£o dispon√≠vel</span>');
            } else {
                status.push('<span class="status-error">‚ùå formatCurrency: Fun√ß√£o n√£o encontrada</span>');
            }
            
            // Verificar formatDate
            if (typeof window.formatDate === 'function') {
                status.push('<span class="status-ok">‚úÖ formatDate: Fun√ß√£o dispon√≠vel</span>');
            } else {
                status.push('<span class="status-error">‚ùå formatDate: Fun√ß√£o n√£o encontrada</span>');
            }
            
            // Verificar Firebase
            if (typeof window.FirebaseDB !== 'undefined') {
                status.push('<span class="status-ok">‚úÖ Firebase: Conectado</span>');
            } else {
                status.push('<span class="status-warning">‚ö†Ô∏è Firebase: N√£o conectado</span>');
            }
            
            statusDiv.innerHTML = status.join('<br>');
        }

        function testeCarregarFuncoes() {
            log('=== TESTE 1: Verificando Fun√ß√µes ===');
            
            try {
                // Verificar se adminData existe
                if (typeof window.adminData !== 'undefined') {
                    log('‚úÖ adminData encontrado', 'success');
                    log(`üìä Total de compras: ${window.adminData.purchases?.length || 0}`);
                } else {
                    log('‚ùå adminData n√£o encontrado', 'error');
                }
                
                // Verificar loadParticipants
                if (typeof window.loadParticipants === 'function') {
                    log('‚úÖ loadParticipants encontrada', 'success');
                } else {
                    log('‚ùå loadParticipants n√£o encontrada', 'error');
                }
                
                // Verificar fun√ß√µes de formata√ß√£o
                if (typeof window.formatCurrency === 'function') {
                    const testValue = window.formatCurrency(120.50);
                    log(`‚úÖ formatCurrency funciona: ${testValue}`, 'success');
                } else {
                    log('‚ùå formatCurrency n√£o encontrada', 'error');
                }
                
                if (typeof window.formatDate === 'function') {
                    const testDate = window.formatDate(new Date());
                    log(`‚úÖ formatDate funciona: ${testDate}`, 'success');
                } else {
                    log('‚ùå formatDate n√£o encontrada', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
            
            log('=== FIM TESTE 1 ===');
        }

        function testeCriarDados() {
            log('=== TESTE 2: Criando Dados de Teste ===');
            
            try {
                // Criar dados de teste
                const dadosTeste = [
                    {
                        id: 'test-01',
                        buyerName: 'Maria Silva (TESTE CORRIGIDO)',
                        buyerPhone: '(11) 99999-1111',
                        buyerEmail: 'maria@teste.com',
                        numbers: [1, 2, 3],
                        totalAmount: 120.00,
                        paymentMethod: 'donation',
                        status: 'pending_donation',
                        date: new Date().toISOString(),
                        timestamp: new Date()
                    },
                    {
                        id: 'test-02',
                        buyerName: 'Jo√£o Santos (CONFIRMADO)',
                        buyerPhone: '(11) 98888-2222',
                        buyerEmail: 'joao@teste.com',
                        numbers: [10, 20, 30],
                        totalAmount: 120.00,
                        paymentMethod: 'pix',
                        status: 'confirmed',
                        date: new Date().toISOString(),
                        timestamp: new Date()
                    },
                    {
                        id: 'test-03',
                        buyerName: 'Ana Costa (REJEITADA)',
                        buyerPhone: '(11) 97777-3333',
                        buyerEmail: 'ana@teste.com',
                        numbers: [50, 51],
                        totalAmount: 80.00,
                        paymentMethod: 'donation',
                        status: 'rejected',
                        date: new Date().toISOString(),
                        timestamp: new Date()
                    }
                ];
                
                // Atualizar adminData se existir
                if (typeof window.adminData !== 'undefined') {
                    window.adminData.purchases = dadosTeste;
                    log(`‚úÖ ${dadosTeste.length} dados de teste criados no adminData`, 'success');
                } else {
                    // Criar adminData b√°sico
                    window.adminData = { purchases: dadosTeste };
                    log(`‚úÖ adminData criado com ${dadosTeste.length} dados de teste`, 'success');
                }
                
                // Salvar no localStorage
                localStorage.setItem('purchases', JSON.stringify(dadosTeste));
                localStorage.setItem('admin_purchases_backup', JSON.stringify(dadosTeste));
                log('üíæ Dados salvos no localStorage', 'success');
                
            } catch (error) {
                log(`‚ùå Erro ao criar dados: ${error.message}`, 'error');
            }
            
            log('=== FIM TESTE 2 ===');
        }

        function testeCarregarParticipantes() {
            log('=== TESTE 3: Carregando Participantes ===');
            
            try {
                const tbody = document.getElementById('participants-tbody');
                if (!tbody) {
                    log('‚ùå Elemento participants-tbody n√£o encontrado', 'error');
                    return;
                }
                
                // Verificar se loadParticipants existe
                if (typeof window.loadParticipants === 'function') {
                    log('üìã Chamando loadParticipants...', 'info');
                    window.loadParticipants();
                    log('‚úÖ loadParticipants executada', 'success');
                } else {
                    log('‚ùå Fun√ß√£o loadParticipants n√£o encontrada', 'error');
                    
                    // Tentar carregar manualmente
                    log('üîß Tentando carregamento manual...', 'warning');
                    
                    if (window.adminData && window.adminData.purchases) {
                        tbody.innerHTML = '';
                        
                        window.adminData.purchases.forEach((purchase, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${purchase.buyerName || 'N/A'}</strong></td>
                                <td>${purchase.buyerPhone || 'N/A'}</td>
                                <td>${(purchase.numbers || []).join(', ')}</td>
                                <td>${window.formatCurrency ? window.formatCurrency(purchase.totalAmount) : 'R$ ' + (purchase.totalAmount || 0).toFixed(2)}</td>
                                <td>${purchase.paymentMethod || 'N/A'}</td>
                                <td><span class="status-badge status-${purchase.status || 'confirmed'}">${purchase.status || 'confirmed'}</span></td>
                                <td>${window.formatDate ? window.formatDate(purchase.date) : new Date(purchase.date).toLocaleDateString('pt-BR')}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button onclick="alert('Teste ${index + 1}')" style="background: #007bff; color: white;">
                                            üîç Teste
                                        </button>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        log(`‚úÖ ${window.adminData.purchases.length} participantes carregados manualmente`, 'success');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Erro ao carregar participantes: ${error.message}`, 'error');
            }
            
            log('=== FIM TESTE 3 ===');
        }

        function testeFormatacao() {
            log('=== TESTE 4: Testando Formata√ß√£o ===');
            
            try {
                // Testar formatCurrency
                if (typeof window.formatCurrency === 'function') {
                    const valores = [0, 10.5, 120.99, 1000, null, undefined];
                    valores.forEach(valor => {
                        const resultado = window.formatCurrency(valor);
                        log(`üí∞ formatCurrency(${valor}) = ${resultado}`, 'info');
                    });
                } else {
                    log('‚ùå formatCurrency n√£o dispon√≠vel', 'error');
                }
                
                // Testar formatDate
                if (typeof window.formatDate === 'function') {
                    const datas = [new Date(), '2025-06-13T10:30:00', null, 'invalid'];
                    datas.forEach(data => {
                        const resultado = window.formatDate(data);
                        log(`üìÖ formatDate(${data}) = ${resultado}`, 'info');
                    });
                } else {
                    log('‚ùå formatDate n√£o dispon√≠vel', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste de formata√ß√£o: ${error.message}`, 'error');
            }
            
            log('=== FIM TESTE 4 ===');
        }

        function testeBotoes() {
            log('=== TESTE 5: Testando Bot√µes ===');
            
            try {
                const tbody = document.getElementById('participants-tbody');
                const botoes = tbody.querySelectorAll('button');
                
                log(`üîò ${botoes.length} bot√µes encontrados na tabela`, 'info');
                
                botoes.forEach((botao, index) => {
                    log(`${index + 1}. ${botao.textContent.trim()}`, 'info');
                });
                
                if (botoes.length > 0) {
                    log('‚úÖ Bot√µes est√£o sendo criados corretamente', 'success');
                } else {
                    log('‚ö†Ô∏è Nenhum bot√£o encontrado', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao testar bot√µes: ${error.message}`, 'error');
            }
            
            log('=== FIM TESTE 5 ===');
        }

        function limparTudo() {
            log('=== LIMPEZA COMPLETA ===');
            
            try {
                // Limpar tabela
                const tbody = document.getElementById('participants-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                üßπ Tabela limpa
                            </td>
                        </tr>
                    `;
                }
                
                // Limpar dados
                if (window.adminData) {
                    window.adminData.purchases = [];
                }
                localStorage.removeItem('purchases');
                localStorage.removeItem('admin_purchases_backup');
                
                // Limpar log
                testLog = [];
                document.getElementById('test-output').innerHTML = '';
                
                log('üßπ Limpeza completa realizada', 'success');
                
            } catch (error) {
                log(`‚ùå Erro na limpeza: ${error.message}`, 'error');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Teste de corre√ß√£o iniciado', 'success');
            updateStatus();
            
            // Atualizar status a cada 2 segundos
            setInterval(updateStatus, 2000);
        });
    </script>
</body>
</html>
