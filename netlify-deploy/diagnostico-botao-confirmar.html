<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç DIAGN√ìSTICO URGENTE - Bot√£o Confirmar N√£o Funciona</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
            font-weight: bold;
        }
        .btn {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-danger { background: #dc3545; color: white; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #dc3545;
            border-radius: 5px;
            background: #f8f9fa;
        }
        .solution-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DIAGN√ìSTICO URGENTE - Bot√£o Confirmar N√£o Funciona</h1>
        
        <div class="status-error">
            ‚ùå PROBLEMA REPORTADO: Tentativa de confirmar compra n√£o resultou em nenhuma a√ß√£o
        </div>

        <div class="test-section">
            <h2>üß™ Diagn√≥stico Completo</h2>
            <button class="btn btn-danger" onclick="diagnosticarProblema()">üîç Diagnosticar Problema</button>
            <button class="btn btn-primary" onclick="testarConfirmacao()">üß™ Teste de Confirma√ß√£o</button>
            <button class="btn btn-success" onclick="criarSolucaoUrgente()">üö® Criar Solu√ß√£o Urgente</button>
        </div>

        <div class="test-section">
            <h2>üìä Log de Diagn√≥stico</h2>
            <div id="logOutput" class="log">Aguardando diagn√≥stico...</div>
        </div>

        <div class="solution-box" id="solucaoBox" style="display: none;">
            <h3>üõ†Ô∏è SOLU√á√ÉO URGENTE</h3>
            <p><strong>Cole este c√≥digo no console (F12) da p√°gina admin:</strong></p>
            <textarea id="codigoSolucao" readonly style="width: 100%; height: 200px; background: #000; color: #0f0; padding: 10px; font-family: monospace; border: 1px solid #ccc; border-radius: 5px;"></textarea>
            <br>
            <button class="btn btn-primary" onclick="copiarSolucao()">üìã Copiar Solu√ß√£o</button>
        </div>
    </div>

    <script>
        let logOutput = document.getElementById('logOutput');
        let originalConsoleLog = console.log;

        // Interceptar console.log
        console.log = function(...args) {
            originalConsoleLog.apply(console, arguments);
            let message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            logOutput.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logOutput.scrollTop = logOutput.scrollHeight;
        };

        function diagnosticarProblema() {
            console.log('üîç INICIANDO DIAGN√ìSTICO COMPLETO');
            console.log('=================================');
            
            // 1. Testar se fun√ß√£o handleConfirmAction existe
            console.log('\n1. üîç Verificando fun√ß√£o handleConfirmAction...');
            try {
                if (typeof handleConfirmAction === 'function') {
                    console.log('‚úÖ Fun√ß√£o handleConfirmAction EXISTS');
                    
                    // Testar a fun√ß√£o
                    console.log('üß™ Testando execu√ß√£o da fun√ß√£o...');
                    handleConfirmAction('test-123');
                    console.log('‚úÖ Fun√ß√£o executou sem erro');
                } else {
                    console.log('‚ùå Fun√ß√£o handleConfirmAction N√ÉO EXISTS');
                }
            } catch (error) {
                console.log('‚ùå ERRO ao testar fun√ß√£o:', error.message);
            }

            // 2. Verificar se h√° conflitos de event listeners
            console.log('\n2. üîç Verificando event listeners...');
            try {
                const buttons = document.querySelectorAll('button');
                console.log(`üìä Total de bot√µes na p√°gina: ${buttons.length}`);
                
                let buttonsWithOnclick = 0;
                let buttonsWithDataAction = 0;
                
                buttons.forEach((btn, i) => {
                    if (btn.onclick) buttonsWithOnclick++;
                    if (btn.getAttribute('data-action')) buttonsWithDataAction++;
                });
                
                console.log(`üìä Bot√µes com onclick: ${buttonsWithOnclick}`);
                console.log(`üìä Bot√µes com data-action: ${buttonsWithDataAction}`);
                
            } catch (error) {
                console.log('‚ùå ERRO ao verificar bot√µes:', error.message);
            }

            // 3. Verificar se h√° problemas com confirm()
            console.log('\n3. üîç Testando fun√ß√£o confirm()...');
            try {
                console.log('üß™ Testando confirm() b√°sico...');
                // N√£o executar confirm real, s√≥ verificar se existe
                if (typeof confirm === 'function') {
                    console.log('‚úÖ Fun√ß√£o confirm() est√° dispon√≠vel');
                } else {
                    console.log('‚ùå Fun√ß√£o confirm() N√ÉO est√° dispon√≠vel');
                }
            } catch (error) {
                console.log('‚ùå ERRO com confirm():', error.message);
            }

            // 4. Verificar se h√° erros JavaScript
            console.log('\n4. üîç Verificando erros JavaScript...');
            console.log('üí° Verifique a aba Console para erros em vermelho');

            console.log('\n=================================');
            console.log('üîç DIAGN√ìSTICO COMPLETO');
        }

        function testarConfirmacao() {
            console.log('üß™ TESTE DE CONFIRMA√á√ÉO ISOLADO');
            console.log('==============================');
            
            // Implementar fun√ß√£o de teste local
            function testeHandleConfirmAction(purchaseId) {
                console.log('‚úÖ TESTE: handleConfirmAction chamada para:', purchaseId);
                
                const confirmado = confirm(`üß™ TESTE: Confirmar doa√ß√£o ${purchaseId}?`);
                if (confirmado) {
                    console.log('‚úÖ TESTE: Usu√°rio confirmou');
                    alert(`‚úÖ TESTE: Doa√ß√£o ${purchaseId} seria confirmada!`);
                    return true;
                } else {
                    console.log('‚ùå TESTE: Usu√°rio cancelou');
                    return false;
                }
            }
            
            // Executar teste
            try {
                console.log('üß™ Executando teste...');
                const resultado = testeHandleConfirmAction('teste-' + Date.now());
                console.log('üß™ Resultado do teste:', resultado);
                console.log('‚úÖ TESTE COMPLETO');
            } catch (error) {
                console.log('‚ùå ERRO no teste:', error.message);
            }
            
            console.log('==============================');
        }

        function criarSolucaoUrgente() {
            console.log('üö® CRIANDO SOLU√á√ÉO URGENTE...');
            
            const solucao = `
// üö® SOLU√á√ÉO URGENTE - Bot√µes de Confirma√ß√£o Funcionais
console.log('üö® APLICANDO CORRE√á√ÉO URGENTE DOS BOT√ïES');

// 1. Redefinir fun√ß√£o handleConfirmAction com logs detalhados
window.handleConfirmAction = function(purchaseId) {
    console.log('üö® URGENTE: handleConfirmAction chamada para:', purchaseId);
    console.log('üö® URGENTE: Tipo de purchaseId:', typeof purchaseId);
    console.log('üö® URGENTE: Valor de purchaseId:', purchaseId);
    
    try {
        // Verificar se confirm est√° dispon√≠vel
        if (typeof confirm !== 'function') {
            console.log('‚ùå URGENTE: confirm() n√£o dispon√≠vel');
            alert('‚ùå Erro: Fun√ß√£o confirm n√£o dispon√≠vel');
            return;
        }
        
        console.log('üß™ URGENTE: Executando confirm...');
        const confirmado = confirm(\`‚úÖ Confirmar doa√ß√£o \${purchaseId}?\nEsta a√ß√£o marcar√° a doa√ß√£o como confirmada.\`);
        
        console.log('üß™ URGENTE: Resultado do confirm:', confirmado);
        
        if (confirmado) {
            console.log('‚úÖ URGENTE: Usu√°rio confirmou a a√ß√£o');
            
            // Mostrar mensagem de sucesso
            alert(\`‚úÖ Doa√ß√£o \${purchaseId} confirmada com sucesso!\nA interface ser√° atualizada.\`);
            
            // TODO: Aqui seria a l√≥gica real de confirma√ß√£o
            console.log('üíæ URGENTE: Aqui salvaria no Firebase');
            console.log('üîÑ URGENTE: Aqui atualizaria a interface');
            
            // For√ßar atualiza√ß√£o da p√°gina como fallback
            if (typeof loadPurchaseData === 'function') {
                console.log('üîÑ URGENTE: Recarregando dados...');
                loadPurchaseData();
            } else {
                console.log('üîÑ URGENTE: Recarregando p√°gina...');
                window.location.reload();
            }
            
        } else {
            console.log('‚ùå URGENTE: Usu√°rio cancelou a a√ß√£o');
        }
        
    } catch (error) {
        console.error('‚ùå URGENTE: Erro na confirma√ß√£o:', error);
        alert(\`‚ùå Erro na confirma√ß√£o: \${error.message}\`);
    }
};

// 2. Redefinir outras fun√ß√µes tamb√©m
window.handleRejectAction = function(purchaseId) {
    console.log('üö® URGENTE: handleRejectAction chamada para:', purchaseId);
    const rejeitado = confirm(\`‚ùå Rejeitar doa√ß√£o \${purchaseId}?\`);
    if (rejeitado) {
        alert(\`‚ùå Doa√ß√£o \${purchaseId} rejeitada!\`);
        console.log('üíæ URGENTE: Rejei√ß√£o seria salva aqui');
    }
};

window.handleEditAction = function(purchaseId) {
    console.log('‚úèÔ∏è URGENTE: handleEditAction chamada para:', purchaseId);
    alert(\`‚úèÔ∏è Editar compra \${purchaseId}\nEsta fun√ß√£o ser√° implementada em breve.\`);
};

window.handleDebugAction = function(purchaseId, purchaseData) {
    console.log('üîç URGENTE: handleDebugAction chamada para:', purchaseId);
    console.log('üìä URGENTE: Dados:', purchaseData);
    alert(\`üîç Debug: \${purchaseId}\nVeja o console para detalhes.\`);
};

// 3. For√ßar atualiza√ß√£o de todos os bot√µes
setTimeout(function() {
    console.log('üîÑ URGENTE: Atualizando todos os bot√µes...');
    
    document.querySelectorAll('#participantsTable tbody tr').forEach((row, index) => {
        const actionCell = row.querySelector('td:last-child');
        if (actionCell) {
            const purchaseId = \`urgente-\${index + 1}-\${Date.now()}\`;
            
            actionCell.innerHTML = \`
                <div class="action-buttons-urgente" style="display: flex; gap: 5px; flex-wrap: wrap;">
                    <button onclick="handleEditAction('\${purchaseId}'); return false;" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ‚úèÔ∏è Editar
                    </button>
                    <button onclick="handleDebugAction('\${purchaseId}', {}); return false;" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        üîç Debug
                    </button>
                    <button onclick="handleConfirmAction('\${purchaseId}'); return false;" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ‚úÖ Confirmar
                    </button>
                    <button onclick="handleRejectAction('\${purchaseId}'); return false;" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ‚ùå Rejeitar
                    </button>
                </div>
            \`;
            
            console.log(\`üîÑ URGENTE: Linha \${index + 1} atualizada\`);
        }
    });
    
    console.log('‚úÖ URGENTE: Todos os bot√µes atualizados');
    
}, 1000);

console.log('‚úÖ CORRE√á√ÉO URGENTE APLICADA');
console.log('üí° Teste os bot√µes agora - eles devem funcionar!');
`;

            const solucaoBox = document.getElementById('solucaoBox');
            const codigoSolucao = document.getElementById('codigoSolucao');
            
            codigoSolucao.value = solucao;
            solucaoBox.style.display = 'block';
            
            console.log('‚úÖ Solu√ß√£o urgente criada');
            console.log('üìã Cole o c√≥digo no console da p√°gina admin');
        }

        function copiarSolucao() {
            const textarea = document.getElementById('codigoSolucao');
            textarea.select();
            document.execCommand('copy');
            console.log('üìã Solu√ß√£o copiada para √°rea de transfer√™ncia');
            alert('‚úÖ C√≥digo copiado! Cole no console da p√°gina admin (F12)');
        }

        // Auto-executar diagn√≥stico b√°sico ao carregar
        window.addEventListener('load', function() {
            console.log('üîç P√°gina de diagn√≥stico carregada');
            console.log('üéØ Pronto para investigar o problema dos bot√µes');
            
            setTimeout(() => {
                console.log('üö® PROBLEMA: Bot√£o confirmar n√£o funciona');
                console.log('üí° Use os bot√µes acima para diagnosticar e resolver');
            }, 1000);
        });
    </script>
</body>
</html>
