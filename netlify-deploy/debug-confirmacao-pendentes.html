<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ Debug ConfirmaÃ§Ã£o de Pendentes</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .result { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #0056b3; }
        .green { background: #28a745; }
        .green:hover { background: #1e7e34; }
        .red { background: #dc3545; }
        .red:hover { background: #c82333; }
        .debug-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .debug-section h3 { margin-top: 0; color: #007bff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; max-height: 300px; }
        .step { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .function-test { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ Debug Completo - ConfirmaÃ§Ã£o de Pendentes</h1>
        
        <div class="debug-section">
            <h3>ğŸ“‹ PreparaÃ§Ã£o de Dados de Teste</h3>
            <button onclick="setupTestData()" class="green">ğŸ†• Criar Dados de Teste</button>
            <button onclick="checkCurrentData()">ğŸ“Š Verificar Dados Atuais</button>
            <button onclick="clearData()" class="red">ğŸ—‘ï¸ Limpar Dados</button>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ” VerificaÃ§Ã£o das FunÃ§Ãµes Admin</h3>
            <button onclick="testAdminFunctions()">ğŸ”¬ Testar FunÃ§Ãµes Existem</button>
            <button onclick="testConfirmationStep()">âœ… Testar ConfirmaÃ§Ã£o Manual</button>
            <button onclick="testFilterStep()">ğŸ” Testar Filtros</button>
        </div>
        
        <div class="debug-section">
            <h3>ğŸŒ Teste Real no Admin</h3>
            <button onclick="openAdminTest()">ğŸ”— Abrir Admin para Teste</button>
            <button onclick="simulateConfirmClick()">ğŸ¯ Simular Clique Confirmar</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info', data = null) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            
            let content = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            div.innerHTML = content;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function setupTestData() {
            log('ğŸ†• Criando dados de teste especÃ­ficos para confirmaÃ§Ã£o...', 'info');
            
            try {
                const testPurchases = [
                    {
                        id: 'test_pending_001',
                        name: 'Maria Silva TESTE',
                        buyerName: 'Maria Silva TESTE',
                        phone: '(11) 99999-1111',
                        buyerPhone: '(11) 99999-1111',
                        numbers: [1, 2, 3],
                        totalAmount: 120.00,
                        paymentMethod: 'doacao',
                        status: 'pending_donation',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    },
                    {
                        id: 'test_pending_002',
                        name: 'JoÃ£o Santos TESTE',
                        buyerName: 'JoÃ£o Santos TESTE',
                        phone: '(11) 99999-2222',
                        buyerPhone: '(11) 99999-2222',
                        numbers: [4, 5, 6],
                        totalAmount: 120.00,
                        paymentMethod: 'doacao',
                        status: 'pending_donation',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    },
                    {
                        id: 'test_confirmed_001',
                        name: 'Ana Costa CONFIRMADO',
                        buyerName: 'Ana Costa CONFIRMADO',
                        phone: '(11) 99999-3333',
                        buyerPhone: '(11) 99999-3333',
                        numbers: [7, 8, 9],
                        totalAmount: 120.00,
                        paymentMethod: 'pix',
                        status: 'confirmed',
                        createdAt: new Date().toISOString(),
                        date: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem('purchases', JSON.stringify(testPurchases));
                
                log('âœ… Dados de teste criados com sucesso!', 'success');
                log('ğŸ“Š Resumo:', 'info', {
                    total: testPurchases.length,
                    pending: 2,
                    confirmed: 1
                });
                
            } catch (error) {
                log(`âŒ Erro ao criar dados: ${error.message}`, 'error');
            }
        }
        
        function checkCurrentData() {
            log('ğŸ“Š Verificando dados atuais no localStorage...', 'info');
            
            try {
                const purchases = localStorage.getItem('purchases');
                
                if (!purchases) {
                    log('âš ï¸ Nenhum dado encontrado no localStorage', 'warning');
                    return;
                }
                
                const parsedPurchases = JSON.parse(purchases);
                
                const analysis = {
                    total: parsedPurchases.length,
                    statusDistribution: {},
                    samples: parsedPurchases.slice(0, 3).map(p => ({
                        id: p.id,
                        name: p.name || p.buyerName,
                        status: p.status,
                        numbers: p.numbers?.length || 0
                    }))
                };
                
                // Contar por status
                parsedPurchases.forEach(p => {
                    const status = p.status || 'unknown';
                    analysis.statusDistribution[status] = (analysis.statusDistribution[status] || 0) + 1;
                });
                
                log('ğŸ“‹ AnÃ¡lise dos dados:', 'success', analysis);
                
                // Verificar se hÃ¡ pendentes
                const pendingCount = analysis.statusDistribution['pending_donation'] || 0;
                if (pendingCount > 0) {
                    log(`âœ… ${pendingCount} doaÃ§Ãµes pendentes encontradas - prontas para teste!`, 'success');
                } else {
                    log('âš ï¸ Nenhuma doaÃ§Ã£o pendente encontrada - crie dados de teste primeiro', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Erro ao verificar dados: ${error.message}`, 'error');
            }
        }
        
        function clearData() {
            if (!confirm('Limpar todos os dados?')) return;
            
            try {
                localStorage.clear();
                log('âœ… Dados limpos', 'success');
            } catch (error) {
                log(`âŒ Erro ao limpar: ${error.message}`, 'error');
            }
        }
        
        function testAdminFunctions() {
            log('ğŸ”¬ Testando se as funÃ§Ãµes admin estÃ£o disponÃ­veis...', 'info');
            
            // Abrir uma nova janela/aba para testar
            const testWindow = window.open('admin.html', 'adminTest', 'width=1200,height=800');
            
            // Dar tempo para carregar
            setTimeout(() => {
                try {
                    // Verificar se as funÃ§Ãµes existem
                    const functionsToCheck = [
                        'confirmDonation',
                        'rejectDonation',
                        'filterParticipants',
                        'loadParticipants',
                        'updateDashboard',
                        'showNotification'
                    ];
                    
                    const results = {};
                    
                    functionsToCheck.forEach(funcName => {
                        try {
                            const exists = typeof testWindow[funcName] === 'function';
                            results[funcName] = exists ? 'âœ… Existe' : 'âŒ NÃ£o existe';
                        } catch (e) {
                            results[funcName] = `âŒ Erro: ${e.message}`;
                        }
                    });
                    
                    log('ğŸ” Resultado do teste de funÃ§Ãµes:', 'info', results);
                    
                    // Fechar janela de teste
                    testWindow.close();
                    
                } catch (error) {
                    log(`âŒ Erro ao testar funÃ§Ãµes: ${error.message}`, 'error');
                    if (testWindow) testWindow.close();
                }
            }, 3000);
            
            log('â³ Aguardando carregamento do admin para teste...', 'info');
        }
        
        function testConfirmationStep() {
            log('âœ… Testando processo de confirmaÃ§Ã£o manual...', 'info');
            
            try {
                const purchases = localStorage.getItem('purchases');
                if (!purchases) {
                    log('âŒ Nenhum dado encontrado - crie dados de teste primeiro', 'error');
                    return;
                }
                
                const parsedPurchases = JSON.parse(purchases);
                const pending = parsedPurchases.find(p => p.status === 'pending_donation');
                
                if (!pending) {
                    log('âŒ Nenhuma doaÃ§Ã£o pendente encontrada', 'error');
                    return;
                }
                
                log(`ğŸ¯ Testando confirmaÃ§Ã£o da doaÃ§Ã£o: ${pending.name}`, 'info');
                
                // Simular processo de confirmaÃ§Ã£o
                const originalStatus = pending.status;
                pending.status = 'confirmed';
                pending.confirmedAt = new Date().toISOString();
                pending.confirmedBy = 'debug_test';
                
                // Salvar de volta
                localStorage.setItem('purchases', JSON.stringify(parsedPurchases));
                
                log('âœ… ConfirmaÃ§Ã£o simulada com sucesso!', 'success');
                log('ğŸ“‹ Dados atualizados:', 'info', {
                    id: pending.id,
                    name: pending.name,
                    statusAnterior: originalStatus,
                    statusAtual: pending.status,
                    confirmedAt: pending.confirmedAt
                });
                
                // Verificar se foi salvo
                const updatedData = JSON.parse(localStorage.getItem('purchases'));
                const confirmedItem = updatedData.find(p => p.id === pending.id);
                
                if (confirmedItem && confirmedItem.status === 'confirmed') {
                    log('âœ… ConfirmaÃ§Ã£o persistida com sucesso no localStorage!', 'success');
                } else {
                    log('âŒ Falha ao persistir confirmaÃ§Ã£o', 'error');
                }
                
            } catch (error) {
                log(`âŒ Erro no teste de confirmaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        function testFilterStep() {
            log('ğŸ” Testando lÃ³gica de filtros...', 'info');
            
            try {
                const purchases = localStorage.getItem('purchases');
                if (!purchases) {
                    log('âŒ Nenhum dado encontrado', 'error');
                    return;
                }
                
                const parsedPurchases = JSON.parse(purchases);
                
                // Testar filtros
                const filters = {
                    all: parsedPurchases,
                    pending_donation: parsedPurchases.filter(p => p.status === 'pending_donation'),
                    confirmed: parsedPurchases.filter(p => p.status === 'confirmed'),
                    rejected: parsedPurchases.filter(p => p.status === 'rejected')
                };
                
                const filterResults = {};
                Object.keys(filters).forEach(filter => {
                    filterResults[filter] = {
                        count: filters[filter].length,
                        items: filters[filter].map(p => `${p.name} (${p.status})`)
                    };
                });
                
                log('ğŸ” Resultado dos filtros:', 'success', filterResults);
                
            } catch (error) {
                log(`âŒ Erro no teste de filtros: ${error.message}`, 'error');
            }
        }
        
        function openAdminTest() {
            log('ğŸ”— Abrindo admin em nova aba para teste manual...', 'info');
            window.open('admin.html', '_blank');
            
            log('ğŸ“ InstruÃ§Ãµes para teste manual:', 'info');
            log('1. Aguarde o admin carregar completamente', 'info');
            log('2. Clique no filtro "ğŸ¼ DoaÃ§Ãµes Pendentes"', 'info');
            log('3. Encontre uma doaÃ§Ã£o pendente na lista', 'info');
            log('4. Clique no botÃ£o "âœ… Confirmar"', 'info');
            log('5. Confirme no popup que aparecer', 'info');
            log('6. Verifique se a doaÃ§Ã£o sai da lista de pendentes', 'info');
        }
        
        function simulateConfirmClick() {
            log('ğŸ¯ Simulando clique de confirmaÃ§Ã£o...', 'info');
            
            // Esta funÃ§Ã£o tentarÃ¡ simular o processo que acontece quando clica em confirmar
            try {
                const purchases = localStorage.getItem('purchases');
                if (!purchases) {
                    log('âŒ Nenhum dado encontrado', 'error');
                    return;
                }
                
                const parsedPurchases = JSON.parse(purchases);
                const pending = parsedPurchases.find(p => p.status === 'pending_donation');
                
                if (!pending) {
                    log('âŒ Nenhuma doaÃ§Ã£o pendente para simular', 'error');
                    return;
                }
                
                log(`ğŸ¯ Simulando confirmaÃ§Ã£o de: ${pending.name}`, 'info');
                
                // Simular o que a funÃ§Ã£o confirmDonation deveria fazer
                const steps = [
                    '1. Encontrar compra no array de dados',
                    '2. Atualizar status para "confirmed"',
                    '3. Adicionar timestamp de confirmaÃ§Ã£o',
                    '4. Salvar no localStorage',
                    '5. Tentar salvar no Firebase (se disponÃ­vel)',
                    '6. Recarregar interface',
                    '7. Mostrar notificaÃ§Ã£o de sucesso'
                ];
                
                steps.forEach((step, index) => {
                    setTimeout(() => {
                        log(`â³ ${step}`, 'info');
                        
                        if (index === steps.length - 1) {
                            // Executar a confirmaÃ§Ã£o real
                            pending.status = 'confirmed';
                            pending.confirmedAt = new Date().toISOString();
                            pending.confirmedBy = 'simulation';
                            
                            localStorage.setItem('purchases', JSON.stringify(parsedPurchases));
                            
                            log(`âœ… SIMULAÃ‡ÃƒO COMPLETA! DoaÃ§Ã£o de ${pending.name} confirmada`, 'success');
                            log('ğŸ”„ Agora teste no admin real para ver se funciona', 'info');
                        }
                    }, index * 500);
                });
                
            } catch (error) {
                log(`âŒ Erro na simulaÃ§Ã£o: ${error.message}`, 'error');
            }
        }
        
        // Auto-verificar ao carregar
        setTimeout(() => {
            checkCurrentData();
        }, 500);
    </script>
</body>
</html>
