<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Casos Espec√≠ficos Sem Bot√µes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .data-item { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background: #f2f2f2; }
        .btn-test { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .field-analysis { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .field-ok { border-left-color: #28a745; }
        .field-problem { border-left-color: #dc3545; }
        .field-warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>üîç Debug - Casos Espec√≠ficos Sem Bot√µes</h1>
    
    <div class="debug-section">
        <h2>üì° Status Firebase</h2>
        <div id="status">Inicializando...</div>
    </div>
    
    <div class="debug-section">
        <h2>üéØ An√°lise de Casos Espec√≠ficos</h2>
        <button class="btn-test" onclick="analisarCasosEspecificos()">Analisar Casos Problem√°ticos</button>
        <div id="casos-especificos"></div>
    </div>
    
    <div class="debug-section">
        <h2>üî¨ Compara√ß√£o: Com Bot√µes vs Sem Bot√µes</h2>
        <button class="btn-test" onclick="compararCasos()">Comparar Casos</button>
        <div id="comparacao"></div>
    </div>
    
    <div class="debug-section">
        <h2>üß™ Teste Manual da L√≥gica</h2>
        <button class="btn-test" onclick="testarLogicaManual()">Testar L√≥gica dos Bot√µes</button>
        <div id="teste-manual"></div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        console.log('üöÄ Iniciando an√°lise de casos espec√≠ficos...');
        
        let todasCompras = [];
        
        // Fun√ß√£o para normalizar strings (mesma do admin.js)
        function normalizeString(str) {
            if (!str) return '';
            return str.toString().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')  // Remove acentos
                .replace(/[^\w\s]/g, '')         // Remove pontua√ß√£o
                .trim();
        }
        
        // Fun√ß√£o para verificar se √© doa√ß√£o (mesma l√≥gica do admin.js)
        function isDoacaoRobusta(purchase) {
            if (!purchase) return false;
            
            const tipoNorm = normalizeString(purchase.tipo);
            const metodoPagamentoNorm = normalizeString(purchase.metodoPagamento);
            const observacoesNorm = normalizeString(purchase.observacoes || '');
            
            const variacoesDoacao = ['doacao', 'doac√£o', 'doa√ß√£o', 'donation'];
            
            return variacoesDoacao.some(variacao => 
                tipoNorm.includes(variacao) || 
                metodoPagamentoNorm.includes(variacao) ||
                observacoesNorm.includes(variacao)
            );
        }
        
        // Fun√ß√£o para verificar se est√° pendente (mesma l√≥gica do admin.js)
        function isStatusPendenteRobusta(purchase) {
            if (!purchase) return false;
            
            const statusNorm = normalizeString(purchase.status);
            const variacoesPendente = ['pendente', 'pending', 'aguardando', 'nao confirmado', 'naoconfirmado'];
            
            return variacoesPendente.some(variacao => statusNorm.includes(variacao));
        }
        
        // Fun√ß√£o para verificar se deve mostrar bot√µes (mesma l√≥gica do admin.js)
        function deveExibirBotoes(purchase) {
            const ehDoacaoPendente = isDoacaoRobusta(purchase) && isStatusPendenteRobusta(purchase);
            
            console.log(`[BUTTON-DEBUG] ID: ${purchase.id || 'N/A'}`);
            console.log(`[BUTTON-DEBUG] Tipo: "${purchase.tipo}" (normalizado: "${normalizeString(purchase.tipo)}")`);
            console.log(`[BUTTON-DEBUG] Status: "${purchase.status}" (normalizado: "${normalizeString(purchase.status)}")`);
            console.log(`[BUTTON-DEBUG] √â doa√ß√£o? ${isDoacaoRobusta(purchase)}`);
            console.log(`[BUTTON-DEBUG] √â pendente? ${isStatusPendenteRobusta(purchase)}`);
            console.log(`[BUTTON-DEBUG] Deve exibir bot√µes? ${ehDoacaoPendente}`);
            
            return ehDoacaoPendente;
        }
        
        // Inicializar Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                document.getElementById('status').innerHTML = '‚úÖ Firebase inicializado com sucesso';
                return true;
            } catch (error) {
                document.getElementById('status').innerHTML = `‚ùå Erro ao inicializar Firebase: ${error.message}`;
                console.error('Erro Firebase:', error);
                return false;
            }
        }
        
        // Carregar todas as compras
        async function carregarTodasCompras() {
            try {
                const db = firebase.firestore();
                const snapshot = await db.collection('purchases').get();
                
                todasCompras = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`üìä Carregadas ${todasCompras.length} compras do Firebase`);
                return todasCompras;
            } catch (error) {
                console.error('‚ùå Erro ao carregar compras:', error);
                return [];
            }
        }
        
        // Analisar casos espec√≠ficos onde bot√µes n√£o aparecem
        async function analisarCasosEspecificos() {
            const statusDiv = document.getElementById('casos-especificos');
            statusDiv.innerHTML = '<div>üîÑ Carregando dados...</div>';
            
            await carregarTodasCompras();
            
            let html = `<h3>üìä An√°lise de ${todasCompras.length} compras encontradas</h3>`;
            
            // Separar casos com e sem bot√µes
            const comBotoes = [];
            const semBotoes = [];
            const doacoesPendentes = [];
            
            todasCompras.forEach(purchase => {
                const ehDoacaoPendente = isDoacaoRobusta(purchase) && isStatusPendenteRobusta(purchase);
                
                if (isDoacaoRobusta(purchase)) {
                    doacoesPendentes.push(purchase);
                    
                    if (ehDoacaoPendente) {
                        comBotoes.push(purchase);
                    } else {
                        semBotoes.push(purchase);
                    }
                }
            });
            
            html += `
                <div class="warning">
                    <h4>üìà Estat√≠sticas Gerais</h4>
                    <ul>
                        <li><strong>Total de compras:</strong> ${todasCompras.length}</li>
                        <li><strong>Doa√ß√µes encontradas:</strong> ${doacoesPendentes.length}</li>
                        <li><strong>Doa√ß√µes COM bot√µes:</strong> ${comBotoes.length}</li>
                        <li><strong>Doa√ß√µes SEM bot√µes:</strong> ${semBotoes.length}</li>
                    </ul>
                </div>
            `;
            
            // Analisar casos sem bot√µes
            if (semBotoes.length > 0) {
                html += `<div class="error"><h4>‚ùå Doa√ß√µes SEM bot√µes (${semBotoes.length} casos)</h4>`;
                
                semBotoes.forEach((purchase, index) => {
                    html += `
                        <div class="data-item">
                            <strong>Caso ${index + 1} - ID: ${purchase.id || 'N/A'}</strong><br>
                            ${analisarCamposPurchase(purchase)}
                            <div style="margin-top: 10px;">
                                <strong>üîç Diagn√≥stico:</strong><br>
                                ${diagnosticarProblema(purchase)}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Mostrar alguns casos com bot√µes para compara√ß√£o
            if (comBotoes.length > 0) {
                html += `<div class="success"><h4>‚úÖ Doa√ß√µes COM bot√µes (${comBotoes.length} casos) - Primeiros 3 para compara√ß√£o</h4>`;
                
                comBotoes.slice(0, 3).forEach((purchase, index) => {
                    html += `
                        <div class="data-item">
                            <strong>Caso ${index + 1} - ID: ${purchase.id || 'N/A'}</strong><br>
                            ${analisarCamposPurchase(purchase)}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        // Analisar os campos de uma compra
        function analisarCamposPurchase(purchase) {
            const campos = [
                { nome: 'tipo', valor: purchase.tipo },
                { nome: 'status', valor: purchase.status },
                { nome: 'metodoPagamento', valor: purchase.metodoPagamento },
                { nome: 'observacoes', valor: purchase.observacoes },
                { nome: 'timestamp', valor: purchase.timestamp },
                { nome: 'usuario', valor: purchase.usuario }
            ];
            
            let html = '';
            campos.forEach(campo => {
                const problema = verificarProblemasCampo(campo.nome, campo.valor);
                const classe = problema ? 'field-problem' : 'field-ok';
                
                html += `
                    <div class="field-analysis ${classe}">
                        <strong>${campo.nome}:</strong> "${campo.valor}" 
                        ${campo.valor ? `(normalizado: "${normalizeString(campo.valor)}")` : ''}
                        ${problema ? `<br><span style="color: red;">‚ö†Ô∏è ${problema}</span>` : ''}
                    </div>
                `;
            });
            
            return html;
        }
        
        // Verificar problemas espec√≠ficos em um campo
        function verificarProblemasCampo(nomeCampo, valor) {
            if (!valor) {
                return `Campo vazio ou nulo`;
            }
            
            if (nomeCampo === 'tipo') {
                const tipoNorm = normalizeString(valor);
                if (!tipoNorm.includes('doacao')) {
                    return `N√£o cont√©m varia√ß√£o de "doa√ß√£o"`;
                }
            }
            
            if (nomeCampo === 'status') {
                const statusNorm = normalizeString(valor);
                if (!statusNorm.includes('pendente') && !statusNorm.includes('pending') && !statusNorm.includes('aguardando')) {
                    return `N√£o √© status pendente`;
                }
            }
            
            return null;
        }
        
        // Diagnosticar por que um caso n√£o tem bot√µes
        function diagnosticarProblema(purchase) {
            const problemas = [];
            
            // Verificar se √© doa√ß√£o
            if (!isDoacaoRobusta(purchase)) {
                const tipoNorm = normalizeString(purchase.tipo);
                const metodoNorm = normalizeString(purchase.metodoPagamento);
                const obsNorm = normalizeString(purchase.observacoes || '');
                
                problemas.push(`‚ùå N√ÉO √â DOA√á√ÉO: tipo="${tipoNorm}", m√©todo="${metodoNorm}", obs="${obsNorm}"`);
            }
            
            // Verificar se √© pendente
            if (!isStatusPendenteRobusta(purchase)) {
                const statusNorm = normalizeString(purchase.status);
                problemas.push(`‚ùå N√ÉO √â PENDENTE: status="${statusNorm}"`);
            }
            
            // Verificar campos obrigat√≥rios
            if (!purchase.tipo) problemas.push('‚ùå Campo "tipo" vazio ou nulo');
            if (!purchase.status) problemas.push('‚ùå Campo "status" vazio ou nulo');
            
            return problemas.length > 0 ? problemas.join('<br>') : '‚úÖ Nenhum problema detectado - isso √© estranho!';
        }
        
        // Comparar casos com e sem bot√µes
        async function compararCasos() {
            const statusDiv = document.getElementById('comparacao');
            statusDiv.innerHTML = '<div>üîÑ Analisando...</div>';
            
            await carregarTodasCompras();
            
            const doacoes = todasCompras.filter(p => isDoacaoRobusta(p));
            const comBotoes = doacoes.filter(p => isStatusPendenteRobusta(p));
            const semBotoes = doacoes.filter(p => !isStatusPendenteRobusta(p));
            
            let html = `
                <h3>üîÑ Compara√ß√£o: Doa√ß√µes Com vs Sem Bot√µes</h3>
                <div class="warning">
                    <p><strong>Doa√ß√µes com bot√µes:</strong> ${comBotoes.length}</p>
                    <p><strong>Doa√ß√µes sem bot√µes:</strong> ${semBotoes.length}</p>
                </div>
            `;
            
            // Tabela comparativa
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Campo</th>
                            <th>Com Bot√µes</th>
                            <th>Sem Bot√µes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Analisar status
            const statusComBotoes = comBotoes.map(p => normalizeString(p.status));
            const statusSemBotoes = semBotoes.map(p => normalizeString(p.status));
            
            html += `
                <tr>
                    <td rowspan="2">Status</td>
                    <td>Valores √∫nicos com bot√µes</td>
                    <td>${[...new Set(statusComBotoes)].join(', ')}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Valores √∫nicos sem bot√µes</td>
                    <td>-</td>
                    <td>${[...new Set(statusSemBotoes)].join(', ')}</td>
                </tr>
            `;
            
            // Analisar tipos
            const tiposComBotoes = comBotoes.map(p => normalizeString(p.tipo));
            const tiposSemBotoes = semBotoes.map(p => normalizeString(p.tipo));
            
            html += `
                <tr>
                    <td rowspan="2">Tipo</td>
                    <td>Valores √∫nicos com bot√µes</td>
                    <td>${[...new Set(tiposComBotoes)].join(', ')}</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Valores √∫nicos sem bot√µes</td>
                    <td>-</td>
                    <td>${[...new Set(tiposSemBotoes)].join(', ')}</td>
                </tr>
            `;
            
            html += '</tbody></table>';
            
            statusDiv.innerHTML = html;
        }
        
        // Testar a l√≥gica manualmente com dados espec√≠ficos
        function testarLogicaManual() {
            const statusDiv = document.getElementById('teste-manual');
            
            // Casos de teste manuais
            const casosTest = [
                { id: 'test1', tipo: 'Doa√ß√£o', status: 'Pendente' },
                { id: 'test2', tipo: 'doacao', status: 'pendente' },
                { id: 'test3', tipo: 'DOACAO', status: 'PENDENTE' },
                { id: 'test4', tipo: 'Doa√ß√£o', status: 'Confirmado' },
                { id: 'test5', tipo: 'Compra', status: 'Pendente' },
                { id: 'test6', tipo: '', status: 'Pendente' },
                { id: 'test7', tipo: 'Doa√ß√£o', status: '' },
                { id: 'test8', tipo: null, status: null },
                { id: 'test9', metodoPagamento: 'Doa√ß√£o PIX', status: 'Pendente' },
                { id: 'test10', observacoes: 'Esta √© uma doa√ß√£o', status: 'Pendente' }
            ];
            
            let html = '<h3>üß™ Teste Manual da L√≥gica dos Bot√µes</h3>';
            
            html += `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>M√©todo/Obs</th>
                            <th>√â Doa√ß√£o?</th>
                            <th>√â Pendente?</th>
                            <th>Deve ter bot√µes?</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            casosTest.forEach(caso => {
                const ehDoacacao = isDoacaoRobusta(caso);
                const ehPendente = isStatusPendenteRobusta(caso);
                const deveTerBotoes = deveExibirBotoes(caso);
                
                html += `
                    <tr>
                        <td>${caso.id}</td>
                        <td>"${caso.tipo || 'null'}"</td>
                        <td>"${caso.status || 'null'}"</td>
                        <td>"${caso.metodoPagamento || caso.observacoes || 'N/A'}"</td>
                        <td>${ehDoacacao ? '‚úÖ' : '‚ùå'}</td>
                        <td>${ehPendente ? '‚úÖ' : '‚ùå'}</td>
                        <td style="background: ${deveTerBotoes ? '#d4edda' : '#f8d7da'}">${deveTerBotoes ? '‚úÖ SIM' : '‚ùå N√ÉO'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            statusDiv.innerHTML = html;
        }
        
        // Inicializar quando a p√°gina carregar
        window.addEventListener('load', function() {
            console.log('üéØ P√°gina carregada, inicializando Firebase...');
            initializeFirebase();
        });
    </script>
</body>
</html>
