<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Sincroniza√ß√£o de Dados</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        
        .data-box {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .button-group {
            margin: 15px 0;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        
        button:hover { background: #0056b3; }
        
        .refresh { background: #28a745; }
        .clear { background: #dc3545; }
        .test { background: #ffc107; color: black; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
        }
        
        .sold { background: #ffcccc; }
        .confirmed { background: #ccffcc; }
        .pending { background: #ffffcc; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico - Sincroniza√ß√£o de Dados</h1>
    <p>Esta p√°gina diagnostica problemas entre p√°gina principal e painel admin</p>

    <div class="button-group">
        <button onclick="runFullDiagnostic()" class="refresh">üîÑ Executar Diagn√≥stico Completo</button>
        <button onclick="testSyncData()" class="test">üß™ Testar Sincroniza√ß√£o</button>
        <button onclick="forceSync()" class="warning">‚ö†Ô∏è For√ßar Sincroniza√ß√£o</button>
        <button onclick="clearAllData()" class="clear">üóëÔ∏è Limpar Dados</button>
    </div>

    <div id="status" class="status"></div>

    <!-- 1. Dados do localStorage -->
    <div class="section">
        <h2>üì¶ 1. Dados do localStorage</h2>
        <div class="button-group">
            <button onclick="loadLocalStorageData()">Carregar Dados</button>
        </div>
        
        <h3>üìã Compras (purchases):</h3>
        <div id="purchases-data" class="data-box">Clique em "Carregar Dados" para ver</div>
        
        <h3>üî¢ Dados da Rifa (rifaData):</h3>
        <div id="rifa-data" class="data-box">Clique em "Carregar Dados" para ver</div>
        
        <h3>‚öôÔ∏è Configura√ß√£o (config):</h3>
        <div id="config-data" class="data-box">Clique em "Carregar Dados" para ver</div>
    </div>

    <!-- 2. Estado da P√°gina Principal -->
    <div class="section">
        <h2>üè† 2. Estado da P√°gina Principal</h2>
        <div class="button-group">
            <button onclick="analyzeMainPageState()">Analisar Estado</button>
        </div>
        <div id="main-state" class="data-box">An√°lise pendente</div>
    </div>

    <!-- 3. N√∫meros Confirmados vs Exibidos -->
    <div class="section">
        <h2>üî¢ 3. Compara√ß√£o: Confirmados vs Exibidos</h2>
        <div class="button-group">
            <button onclick="compareNumbers()">Comparar N√∫meros</button>
        </div>
        
        <h3>N√∫meros Confirmados no Admin:</h3>
        <div id="confirmed-numbers" class="data-box">An√°lise pendente</div>
        
        <h3>N√∫meros Exibidos como Vendidos na P√°gina:</h3>
        <div id="displayed-numbers" class="data-box">An√°lise pendente</div>
        
        <h3>Diferen√ßas Encontradas:</h3>
        <div id="differences" class="data-box">An√°lise pendente</div>
    </div>

    <!-- 4. Simula√ß√£o de Dados -->
    <div class="section">
        <h2>üß™ 4. Teste de Sincroniza√ß√£o</h2>
        <div class="button-group">
            <button onclick="createTestPurchase()">Criar Compra de Teste</button>
            <button onclick="confirmTestPurchase()">Confirmar Compra de Teste</button>
            <button onclick="checkIfSynced()">Verificar Sincroniza√ß√£o</button>
        </div>
        <div id="test-results" class="data-box">Testes pendentes</div>
    </div>

    <!-- 5. A√ß√µes de Corre√ß√£o -->
    <div class="section warning">
        <h2>üîß 5. A√ß√µes de Corre√ß√£o</h2>
        <div class="button-group">
            <button onclick="fixSyncIssue()">Corrigir Sincroniza√ß√£o</button>
            <button onclick="rebuildMainPageNumbers()">Reconstruir N√∫meros da P√°gina</button>
            <button onclick="forceRefreshMainPage()">For√ßar Atualiza√ß√£o da P√°gina</button>
        </div>
        <div id="fix-results" class="data-box">A√ß√µes pendentes</div>
    </div>

    <script>
        let diagnosticData = {
            purchases: [],
            rifaData: {},
            config: {},
            mainPageState: {},
            testPurchaseId: null
        };

        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.className = `status ${type}`;
            status.innerHTML = `[${timestamp}] ${message}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function runFullDiagnostic() {
            log('üîÑ Iniciando diagn√≥stico completo...', 'info');
            
            loadLocalStorageData();
            setTimeout(() => {
                analyzeMainPageState();
                setTimeout(() => {
                    compareNumbers();
                    log('‚úÖ Diagn√≥stico completo finalizado!', 'success');
                }, 500);
            }, 500);
        }

        function loadLocalStorageData() {
            log('üì¶ Carregando dados do localStorage...', 'info');
            
            // Carregar purchases
            const purchasesRaw = localStorage.getItem('purchases');
            diagnosticData.purchases = purchasesRaw ? JSON.parse(purchasesRaw) : [];
            document.getElementById('purchases-data').textContent = JSON.stringify(diagnosticData.purchases, null, 2);
            
            // Carregar rifaData
            const rifaDataRaw = localStorage.getItem('rifaData');
            diagnosticData.rifaData = rifaDataRaw ? JSON.parse(rifaDataRaw) : {};
            document.getElementById('rifa-data').textContent = JSON.stringify(diagnosticData.rifaData, null, 2);
            
            // Carregar config
            const configRaw = localStorage.getItem('config');
            diagnosticData.config = configRaw ? JSON.parse(configRaw) : {};
            document.getElementById('config-data').textContent = JSON.stringify(diagnosticData.config, null, 2);
            
            log(`üìä Dados carregados: ${diagnosticData.purchases.length} compras encontradas`, 'success');
        }

        function analyzeMainPageState() {
            log('üè† Analisando estado da p√°gina principal...', 'info');
            
            // Simular estado da p√°gina principal
            const mainState = {
                soldNumbers: new Set(),
                reservedNumbers: new Set(),
                selectedNumbers: new Set(),
                firebaseReady: false
            };
            
            // Processar n√∫meros vendidos confirmados
            diagnosticData.purchases.forEach(purchase => {
                if (purchase.status === 'confirmed' && purchase.numbers) {
                    purchase.numbers.forEach(number => mainState.soldNumbers.add(number));
                }
            });
            
            // Adicionar n√∫meros do rifaData
            if (diagnosticData.rifaData.soldNumbers) {
                diagnosticData.rifaData.soldNumbers.forEach(number => mainState.soldNumbers.add(number));
            }
            
            if (diagnosticData.rifaData.reservedNumbers) {
                diagnosticData.rifaData.reservedNumbers.forEach(number => mainState.reservedNumbers.add(number));
            }
            
            diagnosticData.mainPageState = {
                soldNumbers: Array.from(mainState.soldNumbers),
                reservedNumbers: Array.from(mainState.reservedNumbers),
                selectedNumbers: Array.from(mainState.selectedNumbers),
                totalSold: mainState.soldNumbers.size,
                totalReserved: mainState.reservedNumbers.size
            };
            
            document.getElementById('main-state').textContent = JSON.stringify(diagnosticData.mainPageState, null, 2);
            
            log(`üî¢ Estado analisado: ${diagnosticData.mainPageState.totalSold} vendidos, ${diagnosticData.mainPageState.totalReserved} reservados`, 'success');
        }

        function compareNumbers() {
            log('üî¢ Comparando n√∫meros confirmados vs exibidos...', 'info');
            
            // N√∫meros confirmados no admin
            const confirmedNumbers = new Set();
            diagnosticData.purchases.forEach(purchase => {
                if (purchase.status === 'confirmed' && purchase.numbers) {
                    purchase.numbers.forEach(number => confirmedNumbers.add(number));
                }
            });
            
            // N√∫meros que deveriam estar exibidos como vendidos
            const shouldBeDisplayed = new Set([...confirmedNumbers]);
            if (diagnosticData.rifaData.soldNumbers) {
                diagnosticData.rifaData.soldNumbers.forEach(number => shouldBeDisplayed.add(number));
            }
            
            // N√∫meros atualmente exibidos (do estado da p√°gina)
            const currentlyDisplayed = new Set(diagnosticData.mainPageState.soldNumbers || []);
            
            // Encontrar diferen√ßas
            const missingFromDisplay = [...shouldBeDisplayed].filter(num => !currentlyDisplayed.has(num));
            const extraInDisplay = [...currentlyDisplayed].filter(num => !shouldBeDisplayed.has(num));
            
            document.getElementById('confirmed-numbers').textContent = 
                `Confirmados (${confirmedNumbers.size}): [${Array.from(confirmedNumbers).sort((a,b) => a-b).join(', ')}]`;
            
            document.getElementById('displayed-numbers').textContent = 
                `Exibidos (${currentlyDisplayed.size}): [${Array.from(currentlyDisplayed).sort((a,b) => a-b).join(', ')}]`;
            
            const differences = {
                missing: missingFromDisplay,
                extra: extraInDisplay,
                hasDifferences: missingFromDisplay.length > 0 || extraInDisplay.length > 0
            };
            
            document.getElementById('differences').textContent = JSON.stringify(differences, null, 2);
            
            if (differences.hasDifferences) {
                log(`‚ö†Ô∏è Diferen√ßas encontradas! ${missingFromDisplay.length} faltando, ${extraInDisplay.length} sobrando`, 'warning');
            } else {
                log('‚úÖ N√∫meros sincronizados corretamente!', 'success');
            }
            
            return differences;
        }

        function testSyncData() {
            log('üß™ Iniciando teste de sincroniza√ß√£o...', 'info');
            loadLocalStorageData();
            analyzeMainPageState();
            const differences = compareNumbers();
            
            if (differences.hasDifferences) {
                log('‚ùå Problema de sincroniza√ß√£o detectado!', 'error');
                return false;
            } else {
                log('‚úÖ Sincroniza√ß√£o funcionando corretamente!', 'success');
                return true;
            }
        }

        function createTestPurchase() {
            log('üß™ Criando compra de teste...', 'info');
            
            const testNumber = Math.floor(Math.random() * 150) + 1;
            const testPurchase = {
                id: `test-${Date.now()}`,
                buyerName: 'Teste Usu√°rio',
                buyerPhone: '(11) 99999-9999',
                numbers: [testNumber],
                totalAmount: 40.00,
                paymentMethod: 'doacao',
                status: 'pending_donation',
                timestamp: new Date().toISOString()
            };
            
            // Adicionar ao localStorage
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            purchases.push(testPurchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            diagnosticData.testPurchaseId = testPurchase.id;
            
            document.getElementById('test-results').textContent = 
                `Compra de teste criada:\nID: ${testPurchase.id}\nN√∫mero: ${testNumber}\nStatus: pending_donation`;
            
            log(`‚úÖ Compra de teste criada - N√∫mero ${testNumber}`, 'success');
        }

        function confirmTestPurchase() {
            if (!diagnosticData.testPurchaseId) {
                log('‚ùå Nenhuma compra de teste encontrada. Crie uma primeiro!', 'error');
                return;
            }
            
            log('‚úÖ Confirmando compra de teste...', 'info');
            
            // Buscar e confirmar a compra
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const testPurchase = purchases.find(p => p.id === diagnosticData.testPurchaseId);
            
            if (testPurchase) {
                testPurchase.status = 'confirmed';
                localStorage.setItem('purchases', JSON.stringify(purchases));
                
                document.getElementById('test-results').textContent += 
                    `\n\nCompra confirmada!\nID: ${testPurchase.id}\nN√∫mero: ${testPurchase.numbers[0]}\nStatus: confirmed`;
                
                log(`‚úÖ Compra de teste confirmada - N√∫mero ${testPurchase.numbers[0]}`, 'success');
            } else {
                log('‚ùå Compra de teste n√£o encontrada!', 'error');
            }
        }

        function checkIfSynced() {
            log('üîç Verificando se a sincroniza√ß√£o funcionou...', 'info');
            
            if (!diagnosticData.testPurchaseId) {
                log('‚ùå Nenhuma compra de teste para verificar!', 'error');
                return;
            }
            
            // Recarregar dados e comparar
            loadLocalStorageData();
            analyzeMainPageState();
            
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const testPurchase = purchases.find(p => p.id === diagnosticData.testPurchaseId);
            
            if (testPurchase && testPurchase.status === 'confirmed') {
                const testNumber = testPurchase.numbers[0];
                const isDisplayedAsSold = diagnosticData.mainPageState.soldNumbers.includes(testNumber);
                
                document.getElementById('test-results').textContent += 
                    `\n\nVerifica√ß√£o:\nN√∫mero ${testNumber} confirmado: ‚úÖ\nExibido como vendido: ${isDisplayedAsSold ? '‚úÖ' : '‚ùå'}`;
                
                if (isDisplayedAsSold) {
                    log('‚úÖ Sincroniza√ß√£o funcionando! N√∫mero aparece como vendido.', 'success');
                } else {
                    log('‚ùå Problema de sincroniza√ß√£o! N√∫mero confirmado n√£o aparece como vendido.', 'error');
                }
            }
        }

        function forceSync() {
            log('‚ö° For√ßando sincroniza√ß√£o...', 'warning');
            
            // Reprocessar todas as compras confirmadas
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const soldNumbers = [];
            
            purchases.forEach(purchase => {
                if (purchase.status === 'confirmed' && purchase.numbers) {
                    soldNumbers.push(...purchase.numbers);
                }
            });
            
            // Atualizar rifaData
            const rifaData = {
                soldNumbers: [...new Set(soldNumbers)],
                reservedNumbers: [],
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('rifaData', JSON.stringify(rifaData));
            
            log(`‚úÖ Sincroniza√ß√£o for√ßada! ${rifaData.soldNumbers.length} n√∫meros marcados como vendidos.`, 'success');
            
            // Recarregar dados
            setTimeout(runFullDiagnostic, 500);
        }

        function fixSyncIssue() {
            log('üîß Corrigindo problemas de sincroniza√ß√£o...', 'warning');
            
            // 1. Reprocessar todas as compras
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const confirmedSoldNumbers = [];
            
            purchases.forEach(purchase => {
                if (purchase.status === 'confirmed' && purchase.numbers) {
                    confirmedSoldNumbers.push(...purchase.numbers);
                }
            });
            
            // 2. Limpar duplicatas
            const uniqueSoldNumbers = [...new Set(confirmedSoldNumbers)];
            
            // 3. Atualizar rifaData com dados limpos
            const rifaData = {
                soldNumbers: uniqueSoldNumbers,
                reservedNumbers: [],
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('rifaData', JSON.stringify(rifaData));
            
            document.getElementById('fix-results').textContent = 
                `Corre√ß√£o aplicada:\n- ${purchases.length} compras processadas\n- ${uniqueSoldNumbers.length} n√∫meros √∫nicos vendidos\n- rifaData atualizado`;
            
            log(`‚úÖ Corre√ß√£o aplicada! ${uniqueSoldNumbers.length} n√∫meros sincronizados.`, 'success');
        }

        function rebuildMainPageNumbers() {
            log('üî® Reconstruindo n√∫meros da p√°gina principal...', 'warning');
            
            // Simular a l√≥gica da p√°gina principal
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const soldNumbers = new Set();
            
            // Processar compras confirmadas
            purchases.forEach(purchase => {
                if (purchase.status === 'confirmed' && purchase.numbers) {
                    purchase.numbers.forEach(number => soldNumbers.add(number));
                }
            });
            
            // Reconstruir rifaData
            const rifaData = {
                soldNumbers: Array.from(soldNumbers),
                reservedNumbers: [],
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('rifaData', JSON.stringify(rifaData));
            
            document.getElementById('fix-results').textContent = 
                `Reconstru√ß√£o conclu√≠da:\n- ${soldNumbers.size} n√∫meros marcados como vendidos\n- rifaData reconstru√≠do\n- Ready para p√°gina principal`;
            
            log(`‚úÖ Reconstru√ß√£o conclu√≠da! ${soldNumbers.size} n√∫meros processados.`, 'success');
        }

        function forceRefreshMainPage() {
            log('üîÑ For√ßando atualiza√ß√£o da p√°gina principal...', 'info');
            
            // Abrir p√°gina principal em nova aba
            const mainPageUrl = '/home/nicps/Documents/Projetos/RifaThomas/index.html';
            window.open(mainPageUrl, '_blank');
            
            log('‚úÖ P√°gina principal aberta em nova aba. Verifique se os n√∫meros est√£o corretos.', 'success');
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai limpar TODOS os dados! Continuar?')) return;
            
            log('üóëÔ∏è Limpando todos os dados...', 'warning');
            
            localStorage.removeItem('purchases');
            localStorage.removeItem('rifaData');
            localStorage.removeItem('config');
            
            // Limpar interface
            document.getElementById('purchases-data').textContent = 'Dados limpos';
            document.getElementById('rifa-data').textContent = 'Dados limpos';
            document.getElementById('config-data').textContent = 'Dados limpos';
            document.getElementById('main-state').textContent = 'Dados limpos';
            document.getElementById('confirmed-numbers').textContent = 'Dados limpos';
            document.getElementById('displayed-numbers').textContent = 'Dados limpos';
            document.getElementById('differences').textContent = 'Dados limpos';
            document.getElementById('test-results').textContent = 'Dados limpos';
            document.getElementById('fix-results').textContent = 'Dados limpos';
            
            diagnosticData = {
                purchases: [],
                rifaData: {},
                config: {},
                mainPageState: {},
                testPurchaseId: null
            };
            
            log('‚úÖ Todos os dados foram limpos!', 'success');
        }

        // Executar diagn√≥stico inicial
        window.addEventListener('load', () => {
            log('üîç P√°gina de diagn√≥stico carregada. Execute um diagn√≥stico completo.', 'info');
        });
    </script>
</body>
</html>
