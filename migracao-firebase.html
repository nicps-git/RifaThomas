<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migra√ß√£o localStorage ‚Üí Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        
        button:hover { background: #0056b3; }
        .success-btn { background: #28a745; }
        .warning-btn { background: #ffc107; color: black; }
        .danger-btn { background: #dc3545; }
        
        .data-box {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîÑ Migra√ß√£o de Dados: localStorage ‚Üí Firebase</h1>
    
    <div class="section warning">
        <h2>‚ö†Ô∏è IMPORTANTE</h2>
        <p><strong>Esta ferramenta migra dados do localStorage para o Firebase.</strong></p>
        <p>Execute os passos na ordem para garantir que os dados sejam transferidos corretamente.</p>
    </div>

    <div class="section">
        <h2>üìã 1. Verificar Dados Locais</h2>
        <button onclick="checkLocalData()" class="success-btn">üîç Verificar localStorage</button>
        
        <div id="local-data" class="data-box">Clique em "Verificar localStorage" para ver os dados...</div>
    </div>

    <div class="section">
        <h2>üî• 2. Testar Conex√£o Firebase</h2>
        <button onclick="testFirebase()" class="success-btn">üß™ Testar Firebase</button>
        
        <div id="firebase-status" class="data-box">Teste de conex√£o Firebase...</div>
    </div>

    <div class="section">
        <h2>üöÄ 3. Migrar Dados</h2>
        <button onclick="startMigration()" class="warning-btn" id="migrate-btn" disabled>üîÑ Iniciar Migra√ß√£o</button>
        <button onclick="clearFirebaseData()" class="danger-btn">üóëÔ∏è Limpar Firebase (Cuidado!)</button>
        
        <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%">0%</div>
        </div>
        
        <div id="migration-log" class="log">Aguardando migra√ß√£o...</div>
    </div>

    <div class="section">
        <h2>‚úÖ 4. Verificar Resultado</h2>
        <button onclick="verifyMigration()" class="success-btn">üîç Verificar Migra√ß√£o</button>
        
        <div id="verification" class="data-box">Verifica√ß√£o aparecer√° aqui...</div>
    </div>

    <!-- Carregar Firebase -->
    <script type="module" src="firebase-config.js"></script>
    
    <script>
        let migrationState = {
            localData: null,
            firebaseReady: false,
            migrationInProgress: false
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('migration-log');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logDiv.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${emoji} ${message}`);
        }

        function updateProgress(percentage, text) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = text || `${percentage}%`;
        }

        function checkLocalData() {
            log('üîç Verificando dados do localStorage...', 'info');
            
            const purchases = localStorage.getItem('purchases');
            const rifaData = localStorage.getItem('rifaData');
            const config = localStorage.getItem('config');
            
            let localData = {
                purchases: purchases ? JSON.parse(purchases) : [],
                rifaData: rifaData ? JSON.parse(rifaData) : {},
                config: config ? JSON.parse(config) : {}
            };
            
            migrationState.localData = localData;
            
            const summary = {
                totalPurchases: localData.purchases.length,
                confirmedPurchases: localData.purchases.filter(p => p.status === 'confirmed').length,
                pendingPurchases: localData.purchases.filter(p => p.status === 'pending_donation').length,
                soldNumbers: localData.rifaData.soldNumbers || [],
                reservedNumbers: localData.rifaData.reservedNumbers || []
            };
            
            document.getElementById('local-data').textContent = 
                `Resumo dos dados locais:\n${JSON.stringify(summary, null, 2)}\n\n` +
                `Dados completos:\n${JSON.stringify(localData, null, 2)}`;
            
            log(`üìä Encontrados: ${summary.totalPurchases} compras (${summary.confirmedPurchases} confirmadas)`, 'success');
            
            if (summary.totalPurchases > 0) {
                log('‚úÖ Dados encontrados no localStorage, prontos para migra√ß√£o', 'success');
            } else {
                log('‚ö†Ô∏è Nenhum dado encontrado no localStorage', 'warning');
            }
        }

        async function testFirebase() {
            log('üî• Testando conex√£o com Firebase...', 'info');
            
            try {
                // Aguardar Firebase carregar
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (typeof window.FirebaseDB === 'undefined') {
                    throw new Error('Firebase n√£o carregado');
                }
                
                // Testar autentica√ß√£o
                await window.FirebaseDB.initAuth();
                log('‚úÖ Autentica√ß√£o Firebase bem-sucedida', 'success');
                
                // Testar leitura
                const result = await window.FirebaseDB.getPurchases();
                if (result.success) {
                    log(`‚úÖ Leitura Firebase bem-sucedida: ${result.data.length} registros`, 'success');
                    
                    document.getElementById('firebase-status').textContent = 
                        `Firebase funcionando:\n` +
                        `- Autentica√ß√£o: ‚úÖ\n` +
                        `- Leitura: ‚úÖ (${result.data.length} registros)\n` +
                        `- Pronto para migra√ß√£o: ‚úÖ`;
                    
                    migrationState.firebaseReady = true;
                    document.getElementById('migrate-btn').disabled = false;
                    
                } else {
                    throw new Error(`Erro na leitura: ${result.error}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste Firebase: ${error.message}`, 'error');
                document.getElementById('firebase-status').textContent = `Erro: ${error.message}`;
                migrationState.firebaseReady = false;
            }
        }

        async function startMigration() {
            if (!migrationState.localData || !migrationState.firebaseReady) {
                log('‚ùå Verifique primeiro os dados locais e a conex√£o Firebase', 'error');
                return;
            }
            
            if (migrationState.migrationInProgress) {
                log('‚ö†Ô∏è Migra√ß√£o j√° em andamento', 'warning');
                return;
            }
            
            migrationState.migrationInProgress = true;
            document.getElementById('migrate-btn').disabled = true;
            
            log('üöÄ Iniciando migra√ß√£o de dados...', 'info');
            updateProgress(0, 'Iniciando...');
            
            try {
                const purchases = migrationState.localData.purchases;
                const total = purchases.length;
                let migrated = 0;
                let errors = 0;
                
                if (total === 0) {
                    log('‚ö†Ô∏è Nenhuma compra para migrar', 'warning');
                    updateProgress(100, 'Conclu√≠do (nenhum dado)');
                    return;
                }
                
                log(`üìã Migrando ${total} compras...`, 'info');
                
                for (let i = 0; i < purchases.length; i++) {
                    const purchase = purchases[i];
                    
                    try {
                        log(`üìù Migrando compra ${i + 1}/${total}: ${purchase.buyerName || purchase.name}`, 'info');
                        
                        const result = await window.FirebaseDB.savePurchase(purchase);
                        
                        if (result.success) {
                            migrated++;
                            log(`‚úÖ Compra migrada: ID ${result.id}`, 'success');
                        } else {
                            errors++;
                            log(`‚ùå Erro na compra ${i + 1}: ${result.error}`, 'error');
                        }
                        
                    } catch (error) {
                        errors++;
                        log(`‚ùå Erro na compra ${i + 1}: ${error.message}`, 'error');
                    }
                    
                    // Atualizar progresso
                    const progress = Math.round(((i + 1) / total) * 100);
                    updateProgress(progress, `${i + 1}/${total}`);
                    
                    // Aguardar um pouco para n√£o sobrecarregar
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`üéâ Migra√ß√£o conclu√≠da! ${migrated} migradas, ${errors} erros`, migrated > 0 ? 'success' : 'warning');
                updateProgress(100, `${migrated}/${total} migradas`);
                
            } catch (error) {
                log(`‚ùå Erro na migra√ß√£o: ${error.message}`, 'error');
                updateProgress(0, 'Erro na migra√ß√£o');
            } finally {
                migrationState.migrationInProgress = false;
                document.getElementById('migrate-btn').disabled = false;
            }
        }

        async function clearFirebaseData() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai apagar TODOS os dados do Firebase!\n\nTem certeza?')) {
                return;
            }
            
            if (!confirm('üö® √öLTIMA CONFIRMA√á√ÉO: Todos os dados do Firebase ser√£o perdidos!\n\nContinuar?')) {
                return;
            }
            
            log('üóëÔ∏è Limpando dados do Firebase...', 'warning');
            
            try {
                const result = await window.FirebaseDB.getPurchases();
                if (result.success) {
                    const total = result.data.length;
                    let deleted = 0;
                    
                    for (const purchase of result.data) {
                        try {
                            await window.FirebaseDB.deletePurchase(purchase.id);
                            deleted++;
                            log(`üóëÔ∏è Deletado: ${purchase.id}`, 'info');
                        } catch (error) {
                            log(`‚ùå Erro ao deletar ${purchase.id}: ${error.message}`, 'error');
                        }
                    }
                    
                    log(`‚úÖ Limpeza conclu√≠da: ${deleted}/${total} registros deletados`, 'success');
                }
            } catch (error) {
                log(`‚ùå Erro na limpeza: ${error.message}`, 'error');
            }
        }

        async function verifyMigration() {
            log('üîç Verificando resultado da migra√ß√£o...', 'info');
            
            try {
                // Dados do localStorage
                const localPurchases = migrationState.localData ? migrationState.localData.purchases : [];
                const localConfirmed = localPurchases.filter(p => p.status === 'confirmed');
                
                // Dados do Firebase
                const firebaseResult = await window.FirebaseDB.getPurchases();
                const firebasePurchases = firebaseResult.success ? firebaseResult.data : [];
                const firebaseConfirmed = firebasePurchases.filter(p => p.status === 'confirmed');
                
                // N√∫meros vendidos
                const soldResult = await window.FirebaseDB.getSoldNumbers();
                const firebaseSoldNumbers = soldResult.success ? soldResult.data : [];
                
                const verification = {
                    localStorage: {
                        totalPurchases: localPurchases.length,
                        confirmedPurchases: localConfirmed.length
                    },
                    firebase: {
                        totalPurchases: firebasePurchases.length,
                        confirmedPurchases: firebaseConfirmed.length,
                        soldNumbers: firebaseSoldNumbers.length,
                        soldNumbersList: firebaseSoldNumbers.sort((a,b) => a-b)
                    },
                    status: 'unknown'
                };
                
                // Determinar status
                if (verification.firebase.totalPurchases >= verification.localStorage.totalPurchases) {
                    verification.status = 'success';
                    log('‚úÖ Migra√ß√£o bem-sucedida! Firebase tem todos os dados', 'success');
                } else if (verification.firebase.totalPurchases > 0) {
                    verification.status = 'partial';
                    log('‚ö†Ô∏è Migra√ß√£o parcial. Alguns dados podem estar faltando', 'warning');
                } else {
                    verification.status = 'failed';
                    log('‚ùå Migra√ß√£o falhou. Firebase est√° vazio', 'error');
                }
                
                document.getElementById('verification').textContent = JSON.stringify(verification, null, 2);
                
            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error');
                document.getElementById('verification').textContent = `Erro: ${error.message}`;
            }
        }

        // Inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üöÄ Ferramenta de migra√ß√£o carregada', 'info');
            log('üìã Execute os passos na ordem para migrar dados com seguran√ßa', 'info');
        });
    </script>
</body>
</html>
